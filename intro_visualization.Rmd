---
title: "Visualizing Data"
subtitle: "An introduction to ggplot2"
author: "CSC/ST 442"
date: "Fall 2019"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [default, metropolis, metropolis-fonts]
    nature:
      highlightStyle: zenburn
      highlightLines: true
      countIncrementalSlides: false
    df_print: tibble

--- 
```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.retina = 3, fig.asp = 0.6, fig.align = 'center', out.width = "120%", warning = FALSE, message = FALSE)
options(htmltools.dir.version = FALSE, digits = 3, knitr.table.format = "html",tibble.print_min=6)
```

```{r xaringan-themer, include = FALSE}
library(xaringanthemer)
library(tidyverse)
# duo_accent(primary_color = "#006747", secondary_color = "#CFC493",
#   title_slide_background_color = "#FFFFFF",
#   title_slide_text_color = "#006747",
#   header_font_google = google_font("Josefin Sans"),
#   title_slide_background_image = "ncstate.png",
#   title_slide_background_size = "600px",
#   title_slide_background_position = "bottom",
#   text_font_google   = google_font("Montserrat", "300", "300i"),
#   code_font_family = "Fira Code",
#   code_font_url = "https://cdn.rawgit.com/tonsky/FiraCode/1.204/distr/fira_code.css"
# )
# duo(primary_color = "#1F4257", secondary_color = "#F97B64",
#   text_font_google   = google_font("Montserrat", "300", "300i"),
#   code_font_family = "Fira Code",
#   code_font_url = "https://cdn.rawgit.com/tonsky/FiraCode/1.204/distr/fira_code.css"
# )
```

#ggplot2
We introduce the **ggplot2** package which provides a unifying framework and, correspondingly, a grammar for describing and specifying graphics. The use of a grammar allows for a coherent system for describing and building graphics using a number of simple and well-defined commands. 

Some useful online resources on on **ggplot2** are
+ A comprehensive description of **ggplot2** is available from [ggplot2: Elegant graphics for data analysis](https://catalog.lib.ncsu.edu/catalog/NCSU3716602)

+ Detailed examples are given in [R Graphics Cookbook](https://r-graphics.org). 

+ A neat cheat sheet is the [R Studio ggplot2 cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)
---
class: clear

As an example, the following figure was generated using data from the average daily temperature archive at the [University of Daytona](http://academic.udayton.edu/kissock/http/Weather/).

```{r echo = FALSE, cache = TRUE, warning = FALSE, message = FALSE, fig.retina = 4, fig.align = 'center', out.width="120%", fig.asp = 0.6}
source("daytona.R")
p <- daytona_plot()
print(p)
```
---
class: clear
As another example, consider the following famous plot of Charles Minard on Napoleon's 1812 winter retreat from Moscow. During this excursion, the Grande Armee dropped from $422000$ to $10000$ troops.

```{r echo = FALSE}
knitr::include_graphics("https://www.andrewheiss.com/files/images/minard/Minard.png")
```
---
class: clear
A **R** version generated by **ggplot2** code is below.

```{r, echo = FALSE, cache = TRUE, warning = FALSE, message = FALSE, fig.retina = 4, out.width = "120%", fig.asp = 0.5}
source("napoleon_fig/napoleon_fig.R")
p <- napoleon_plot()
grid::grid.newpage()
grid::grid.draw(p)
```

Close, but no cigar ? In any case, the above plot is nice in that a total of six variables are mapped to six *aesthetics*; $x$ and $y$ axis mapped to the location of the army, the size of the army is mapped to the size of the line, the direction of movement is mapped to color, date of points along retreat path is mapped to the text below plot, and the temperature during the retreat is mapped to the line below the plot.
---
#ggplot2 basic
We start with a very simple plot. Consider the following dataset about fuel efficieny for cars.

```{r echo = -2, fig.align = 'center', out.width = "50%"}
library(ggplot2)
theme_set(theme_classic())
data(mpg)
select(mpg, -fl, -class)
```
---
class: clear
We now plot a scatterplot of the relationship between engine size vs
mile per gallon for highway driving.

```{r, fig.align = 'center', out.width = "80%", fig.asp = 0.6, fig.retina = 3}
p <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy)) + 
  xlab("Engine Size") + ylab("Highway mile per gallon")
p
```
---
class: clear
We next color the cars based on its class (e.g., compact vs suv vs pickup)
```{r fig.align = 'center', out.width = "80%", fig.asp = 0.6, fig.retina = 3}
p <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, color = class)) + 
  xlab("Engine Size") + ylab("Highway mile per gallon")
p
```
---
class: clear
Compare the previous plot with the following two plots.
```{r fig.align = 'center', fig.asp = 0.4, message = FALSE, fig.retina = 3, out.width = "120%"}
p1 <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, size = class))
p2 <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, alpha = class))
require(gridExtra)
grid.arrange(p1,p2,ncol = 2)
```
---
#aes()
We see that the plots differ in which aesthetic the variable *class* is mapped to, e.g., color vs size vs alpha translucency.

A variable can be mapped to a number of different aesthetics; the choice of aesthetics also depend on the *geom\_function* that is used. For example, $\mathrm{geom\_point}$ understands the following aesthetics
+ $x$ and $y$ for coordinates (required)
+ $\mathrm{alpha}$, $\mathrm{color}$, $\mathrm{fill}$ for color and shade.
+ $\mathrm{size}$, $\mathrm{shape}$ and $\mathrm{stroke}$.
+ $\mathrm{group}$ (not used?)

In contrasts, $\mathrm{geom\_line}$ understands the following aesthetics
+ $x$ and $y$ (required)
+ $\mathrm{alpha}$ and $\mathrm{color}$
+ $\mathrm{linetype}$ and $\mathrm{size}$
+ $\mathrm{group}$ (use to draw multiple lines, one for each group)
---
class: clear
We can also set an aesthetic manually, i.e., does not map it to a variable, by setting the aesthetic to a constant outside of the $\mathrm{aes()}$ call, e.g.,
```{r out.width = "80%", fig.asp = 0.6, fig.retina = 3}
ggplot(mpg) + 
  geom_point(aes(x = displ, y = hwy), color = "blue", shape = 24)
```
---
#facet
We can also introduce additional (categorical) variables through the use of faceting, i.e., split your data into groups and display different subplots (but using the same *geom_functions*) for each subgroups. 
```{r, fig.align = 'center', out.width = "70%", fig.asp = 0.6, fig.retina = 3}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, col = cyl)) +
  facet_wrap(~ class, nrow = 2)
```
---
class: clear
We can also facet our plots using a combination of two (categorical) variables, e.g.,
```{r, fig.align = 'center', out.width = "80%", fig.asp = 0.6, fig.retina = 3}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, col = cyl)) +
  facet_grid(drv ~ cyl)
```
---
#Geometric objects
Consider the following three plots. Each plot uses the same $x$ and $y$ coordinates, but different *geoms* or geometric objects.
```{r, out.width = "100%", fig.show = 'hold', fig.asp = 0.4}
p <- ggplot(data = mpg, mapping = aes(x = displ, y = hwy))
p1 <- p + geom_point() + ggtitle("Plot 1")
p2 <- p + geom_smooth() + ggtitle("Plot 2")
p3 <- p + geom_point() + geom_smooth() + ggtitle("Plot 3")
grid.arrange(p1,p2,p3, ncol = 3)
```
---
class: clear
Compare also the following two plots.
```{r, fig.asp = 0.5}
p <- ggplot(data = mpg, mapping = aes(x = displ, y = hwy))
p1 <- p + geom_point(aes(color = drv))
p2 <- p + geom_smooth(aes(color = drv))
grid.arrange(p1,p2,ncol = 2)
```
---
class: clear
Finally, each geom object can also use different data set.
```{r out.width = "80%"}
ggplot(mpg, mapping = aes(x = displ, y = hwy)) +
  geom_point(aes(color = class), show.legend = FALSE) + 
  geom_smooth(data = filter(mpg, class == "subcompact"))
```
---
#Histograms and Bar Plots
We now present examples of two of the most elementary and widely used plots.
```{r cache = TRUE, fig.asp = 0.5, out.width="80%"}
library(mdsr) ## from the book Modern Data Science with R
data(SAT_2010)
p1 <- ggplot(SAT_2010, aes(x = math)) + geom_histogram(binwidth=10)
p2 <- ggplot(SAT_2010, aes(x = math)) + geom_density() + geom_rug()
grid.arrange(p1,p2,ncol = 2)
```
---
class: clear
Compare the following two plots. For more details, see the section for computed variables in $\mathrm{?geom\_histogram()}$.
```{r cache = TRUE, out.width = "80%", fig.asp = 0.5}
p1 <- ggplot(SAT_2010, aes(x = math)) + geom_histogram(binwidth = 10)
p2 <- ggplot(SAT_2010, aes(x = math)) + 
  geom_histogram(aes(y = ..density..),binwidth=10)
grid.arrange(p1,p2,ncol = 2)
```
---
class: clear
Compare the following two plots.
```{r cache = TRUE, fig.asp = 0.5}
p <- ggplot(data = head(SAT_2010,10),
            aes(x = reorder(state, math))) + xlab("") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
p1 <- p + geom_bar() 
p2 <- p + geom_bar(aes(y = math), stat = "identity")
grid.arrange(p1,p2,ncol = 2)
```
---
# Example 1: US Gun Murders in 2010
We now present a few more sophisticated examples of **ggplot2** output. 
```{r echo = -5}
## The package dslabs accompanies the book 
## Introduction to Data Science @ https://rafalab.github.io/dsbook/
library(dslabs)
data(murders)
knitr::kable(head(murders))
```
---
class: clear
We start with the most naive plot. This plot exhibits an undesirable property in that there are a few points that are far from the remaining points (states with large population and a lot of murders)
```{r out.width = "80%"}
p <- ggplot(murders, aes(x = population/10^6, y = total)) + 
  geom_point()
p
```
---
class: clear
We remedy the above situation by plotting on a $\log$ $\log$ scale.
```{r out.width = "80%"}
p <- p + scale_x_continuous(trans = "log10") +
         scale_y_continuous(trans = "log10")
p
```
---
class: clear
We now add text labels.
```{r out.width = "80%"}
p + geom_text(aes(label = abb))
```
---
class: clear
The previous output looks quite a bit ugly as the text is all jumbled up with the data points. We can adjust this by nudging the labels slightly.
```{r out.width = "80%"}
p + geom_text(aes(label = abb), nudge_x = 0.1)
```
---
class: clear
The output is not really improved. So we give up and call in the big guns.
```{r out.width = "80%"}
library(ggrepel)
p + geom_text_repel(aes(label = abb))
```
---
A few more polishing touches yield

```{r echo = FALSE, out.width = "80%"}
library(ggthemes)
p <- ggplot(murders, aes(x = population/10^6, y = total)) +
  geom_point(aes(col = region), size = 3) + 
  geom_text_repel(aes(label = abb)) +
  scale_x_log10() + scale_y_log10() +
  xlab("Population in millions (log scale)") + 
  ylab("Murders (log scale)") + 
  ggtitle("US Gun Murders in 2010") + 
  scale_color_discrete(name = "Region") + 
  geom_smooth(method = "lm", se = FALSE) +
  theme_fivethirtyeight()
p
```