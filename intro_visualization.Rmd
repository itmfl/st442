---
title: "Visualizing Data"
subtitle: "An introduction to ggplot2"
author: "CSC/ST 442"
date: "Fall 2019"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [default, metropolis, metropolis-fonts]
    nature:
      highlightStyle: zenburn
      highlightLines: true
      countIncrementalSlides: false
   
--- 
```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.retina = 3, fig.asp = 0.6, fig.align = 'center', out.width = "120%", warning = FALSE, message = FALSE)
options(htmltools.dir.version = FALSE, digits = 3, knitr.table.format = "html",tibble.print_min=6)
```

```{r xaringan-themer, include = FALSE}
library(tidyverse)
# duo_accent(primary_color = "#006747", secondary_color = "#CFC493",
#   title_slide_background_color = "#FFFFFF",
#   title_slide_text_color = "#006747",
#   header_font_google = google_font("Josefin Sans"),
#   title_slide_background_image = "ncstate.png",
#   title_slide_background_size = "600px",
#   title_slide_background_position = "bottom",
#   text_font_google   = google_font("Montserrat", "300", "300i"),
#   code_font_family = "Fira Code",
#   code_font_url = "https://cdn.rawgit.com/tonsky/FiraCode/1.204/distr/fira_code.css"
# )
# duo(primary_color = "#1F4257", secondary_color = "#F97B64",
#   text_font_google   = google_font("Montserrat", "300", "300i"),
#   code_font_family = "Fira Code",
#   code_font_url = "https://cdn.rawgit.com/tonsky/FiraCode/1.204/distr/fira_code.css"
# )
```

#ggplot2
We introduce the **ggplot2** package which provides a unifying framework and, correspondingly, a grammar for describing and specifying graphics. The use of a grammar allows for a coherent system for describing and building graphics using a number of simple and well-defined commands. 

Some useful online resources on on **ggplot2** are
+ The book [ggplot2: Elegant graphics for data analysis](https://catalog.lib.ncsu.edu/catalog/NCSU3716602)

+ The [R Graphics Cookbook](https://r-graphics.org). 

+ The [R Studio ggplot2 cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)
---
class: clear

As an example, the following figure was generated using data from the average daily temperature archive at the [University of Daytona](http://academic.udayton.edu/kissock/http/Weather/).

```{r echo = FALSE, cache = TRUE, warning = FALSE, message = FALSE, fig.retina = 4, fig.align = 'center', out.width="120%", fig.asp = 0.6}
source("daytona.R")
p <- daytona_plot()
print(p)
```
---
class: clear
As another example, consider the following famous plot of Charles Minard on Napoleon's 1812 winter retreat from Moscow. During this excursion, the Grande Armee dropped from $422000$ to $10000$ troops.

```{r echo = FALSE}
knitr::include_graphics("https://www.andrewheiss.com/files/images/minard/Minard.png")
```
---
class: clear
A **R** version generated by **ggplot2** code is below.

```{r, echo = FALSE, cache = TRUE, warning = FALSE, message = FALSE, fig.retina = 4, out.width = "120%", fig.asp = 0.5}
source("napoleon_fig/napoleon_fig.R")
p <- napoleon_plot()
grid::grid.newpage()
grid::grid.draw(p)
```

Close, but no cigar ? In any case, the above plot is nice in that a total of six variables are mapped to six *aesthetics*; $x$ and $y$ axis mapped to the location of the army, the size of the army is mapped to the size of the line, the direction of movement is mapped to color, date of points along retreat path is mapped to the text below plot, and the temperature during the retreat is mapped to the line below the plot.
---
#ggplot2 basic
We start with a very simple plot. Consider the following dataset about fuel efficieny for cars.

```{r echo = -2, fig.align = 'center', out.width = "50%"}
library(ggplot2)
theme_set(theme_classic())
data(mpg)
select(mpg, -fl, -class)
```
---
class: clear
We now plot a scatterplot of the relationship between engine size vs
mile per gallon for highway driving.

```{r, fig.align = 'center', out.width = "80%", fig.asp = 0.6, fig.retina = 3}
p <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy)) + 
  xlab("Engine Size") + ylab("Highway mile per gallon")
p
```
---
class: clear
We next color the cars based on its class (e.g., compact vs suv vs pickup)
```{r fig.align = 'center', out.width = "80%", fig.asp = 0.6, fig.retina = 3}
p <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, color = class)) + 
  xlab("Engine Size") + ylab("Highway mile per gallon")
p
```
---
class: clear
Compare the previous plot with the following two plots.
```{r fig.align = 'center', fig.asp = 0.4, message = FALSE, fig.retina = 3, out.width = "120%"}
p1 <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, size = class))
p2 <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, alpha = class))
require(gridExtra)
grid.arrange(p1,p2,ncol = 2)
```
---
#aes()
We see that the plots differ in which aesthetic the variable *class* is mapped to, e.g., color vs size vs alpha translucency.

A variable can be mapped to a number of different aesthetics; the choice of aesthetics also depend on the *geom\_function* that is used. For example, $\mathrm{geom\_point}$ understands the following aesthetics
+ $x$ and $y$ for coordinates (required)
+ $\mathrm{alpha}$, $\mathrm{color}$, $\mathrm{fill}$ for color and shade.
+ $\mathrm{size}$, $\mathrm{shape}$ and $\mathrm{stroke}$.
+ $\mathrm{group}$ (not used?)

In contrasts, $\mathrm{geom\_line}$ understands the following aesthetics
+ $x$ and $y$ (required)
+ $\mathrm{alpha}$ and $\mathrm{color}$
+ $\mathrm{linetype}$ and $\mathrm{size}$
+ $\mathrm{group}$ (use to draw multiple lines, one for each group)
---
class: clear
We can also set an aesthetic manually, i.e., does not map it to a variable, by setting the aesthetic to a constant outside of the $\mathrm{aes()}$ call, e.g.,
```{r out.width = "80%", fig.asp = 0.6, fig.retina = 3}
ggplot(mpg) + 
  geom_point(aes(x = displ, y = hwy), color = "blue", shape = 24)
```
---
#facet
We can also introduce additional (categorical) variables through the use of faceting, i.e., split your data into groups and display different subplots (but using the same *geom_functions*) for each subgroups. 
```{r, fig.align = 'center', out.width = "70%", fig.asp = 0.6, fig.retina = 3}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, col = cyl)) +
  facet_wrap(~ class, nrow = 2)
```
---
class: clear
We can also facet our plots using a combination of two (categorical) variables, e.g.,
```{r, fig.align = 'center', out.width = "80%", fig.asp = 0.6, fig.retina = 3}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, col = cyl)) +
  facet_grid(drv ~ cyl)
```
---
#Geometric objects
Consider the following three plots. Each plot uses the same $x$ and $y$ coordinates, but different *geoms* or geometric objects.
```{r, out.width = "100%", fig.show = 'hold', fig.asp = 0.4}
p <- ggplot(data = mpg, mapping = aes(x = displ, y = hwy))
p1 <- p + geom_point() + ggtitle("Plot 1")
p2 <- p + geom_smooth() + ggtitle("Plot 2")
p3 <- p + geom_point() + geom_smooth() + ggtitle("Plot 3")
grid.arrange(p1,p2,p3, ncol = 3)
```
---
class: clear
Compare also the following two plots.
```{r, fig.asp = 0.5}
p <- ggplot(data = mpg, mapping = aes(x = displ, y = hwy))
p1 <- p + geom_point(aes(color = drv))
p2 <- p + geom_smooth(aes(color = drv))
grid.arrange(p1,p2,ncol = 2)
```
---
class: clear
Finally, each geom object can also use different data set.
```{r out.width = "80%"}
ggplot(mpg, mapping = aes(x = displ, y = hwy)) +
  geom_point(aes(color = class), show.legend = FALSE) + 
  geom_smooth(data = filter(mpg, class == "subcompact"))
```
---
#Histograms and Bar Plots
We now present examples of two of the most elementary and widely used plots.
```{r cache = TRUE, fig.asp = 0.5, out.width="80%"}
library(mdsr) ## from the book Modern Data Science with R
data(SAT_2010)
p1 <- ggplot(SAT_2010, aes(x = math)) + geom_histogram(binwidth=10)
p2 <- ggplot(SAT_2010, aes(x = math)) + geom_density() + geom_rug()
grid.arrange(p1,p2,ncol = 2)
```
---
class: clear
Compare the following two plots. For more details, see the section for computed variables in $\mathrm{?geom\_histogram()}$.
```{r cache = TRUE, out.width = "80%", fig.asp = 0.5}
p1 <- ggplot(SAT_2010, aes(x = math)) + geom_histogram(binwidth = 10)
p2 <- ggplot(SAT_2010, aes(x = math)) + 
  geom_histogram(aes(y = ..density..),binwidth=10)
grid.arrange(p1,p2,ncol = 2)
```
---
class: clear
Compare the following two plots.
```{r cache = TRUE, fig.asp = 0.5}
p <- ggplot(data = head(SAT_2010,10),
            aes(x = reorder(state, math))) + xlab("") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
p1 <- p + geom_bar() 
p2 <- p + geom_bar(aes(y = math), stat = "identity")
grid.arrange(p1,p2,ncol = 2)
```
---
#Polished graphics
Plots generated from *ggplot2* is reasonably polished, but a little touches here and there can make these graphics even better. We illustrate this by visualizing the temperature anomaly pattern in Berkeley, CA.
```{r}
library(gcookbook) # Load gcookbook for the climate data set
library(dplyr)

climate_sub <- climate %>%
  filter(Source == "Berkeley" & Year >= 1900) %>%
  mutate(pos = Anomaly10y >= 0) %>% as.tibble()

climate_sub
```
---
class: clear
```{r out.width = "70%"}
p <- ggplot(climate_sub, aes(x = Year, y = Anomaly10y, fill = pos))
p + geom_col()
```

This figure looks fine but the color are "reversed" and the legend is redundant and distracting.
---
class: clear
```{r out.width = "70%"}
p + geom_col(colour = "black", size = 0.25) +
  scale_fill_manual(values = c("#CCEEFF", "#FFDDDD"), guide = FALSE)
```
---
# Example 1: US Gun Murders in 2010
We now present a few more sophisticated examples of **ggplot2** output. 
```{r echo = -5}
## The package dslabs accompanies the book 
## Introduction to Data Science @ https://rafalab.github.io/dsbook/
library(dslabs)
data(murders)
knitr::kable(head(murders))
```
---
class: clear
We start with the most naive plot. This plot exhibits an undesirable property in that there are a few points that are far from the remaining points (states with large population and a lot of murders)
```{r out.width = "80%"}
p <- ggplot(murders, aes(x = population/10^6, y = total)) + 
  geom_point()
p
```
---
class: clear
We remedy the above situation by plotting on a $\log$ $\log$ scale.
```{r out.width = "80%"}
p <- p + scale_x_continuous(trans = "log10") +
         scale_y_continuous(trans = "log10")
p
```
---
class: clear
We now add text labels.
```{r out.width = "80%"}
p + geom_text(aes(label = abb))
```
---
class: clear
The previous output looks quite a bit ugly as the text is all jumbled up with the data points. We can adjust this by nudging the labels slightly.
```{r out.width = "80%"}
p + geom_text(aes(label = abb), nudge_x = 0.1)
```
---
class: clear
The output is not really improved. So we give up and call in the big guns.
```{r out.width = "80%"}
library(ggrepel)
p + geom_text_repel(aes(label = abb))
```
---
class: clear
A few more polishing touches yield the following output

```{r out.width = "80%", echo = FALSE}
knitr::include_graphics(knitr::fig_chunk("plot-label","png"))
```

---
class: clear
The code generating the previous plot is

```{r plot-label, fig.show = "hide", out.width = "60%"}
library(ggthemes)
p <- ggplot(murders, aes(x = population/10^6, y = total)) +
  geom_point(aes(col = region), size = 3) + 
  geom_text_repel(aes(label = abb)) +
  scale_x_log10() + scale_y_log10() +
  xlab("Population in millions (log scale)") + 
  ylab("Murders (log scale)") + 
  ggtitle("US Gun Murders in 2010") + 
  scale_color_discrete(name = "Region") + 
  geom_smooth(method = "lm", se = FALSE) +
  theme_economist()
p
```
---
# Example 2: Historical baby names
This example tries to reproduce a few representative figures/plots from the article *How to tell someone's age when all you know is her name* on the website [Five Thirty Eight](https://fivethirtyeight.com/features/how-to-tell-someones-age-when-all-you-know-is-her-name/). The example follows section 3.3 of the book *Modern Data Science with R* and uses data from the **babynames** package; this package contains information about roughly $1.6$ million names during the period from $1900$ to $2010$. A snippet of the data is as follows.

```{r cache = FALSE, echo = FALSE}
library(mdsr)
library(babynames)
BabyNamesDist <- make_babynames_dist()
knitr::kable(head(BabyNamesDist))
```
---
class: clear
We aim to generate plots such as the one below. This plot describe the age distribution of boys born in the USA whose name is Joseph. The name Joseph reaches peak popularity during the $1950$'s and appears to be declining in popularity since the mid $1990$'s. 

```{r fig.retina = 3, out.width = "80%", echo = FALSE}
joseph <- filter(BabyNamesDist, name == "Joseph", sex == "M")
p <- ggplot(data = joseph, aes(x = year))
p <- p + geom_bar(stat = "identity", aes(y = count_thousands * alive_prob), 
                  fill = "#b2d7e8", color = "white")
p <- p + geom_line(aes(y = count_thousands), size = 2)
p <- p + ylab("Number of people (thousands)") + xlab(NULL) + theme_fivethirtyeight()
median_yob <- joseph %>% 
  group_by(year) %>% 
  summarise(count = sum(est_alive_today)) %>% 
  mutate(prop = cumsum(count)/sum(count)) %>%
  filter(cumany(prop >= 0.5)) %>% ## a binary search is more efficient
  select(year) %>% pull() %>% first()
p <- p + geom_bar(stat = "identity", 
                  aes(y = ifelse(year == median_yob, est_alive_today/1000, 0)),
                  colour = "white", fill = "#008fd5")
p + ggtitle("Age Distribution of American boys named Joseph") +
  geom_text(x = 1935, y = 30, label = "Number of Josephs\nborn each year") +
  geom_text(x = 1915, y = 13, label = "Number of Josephs\nborn each year\nestimated to be alive\non 1/1/2014",color="#b2d7e9") + ylim(0,42) + 
  geom_text(x = 2003, y = 40, label = "The median\nliving Joseph\nis 37 years old", color = "darkgray") + 
  geom_curve(aes(x = 1995, xend = 1974, y = 40, yend = 24), arrow = arrow(length = unit(0.3,"cm")), curvature = 0.5)
```
---
class: clear
We first generate the blue bars and the black line in the previous plot.
```{r out.width = "70%", eval = FALSE}
name <- "Joseph"
joseph <- filter(BabyNamesDist, name == "Joseph", sex == "M")
p <- ggplot(joseph, aes(x = year)) + 
  geom_bar(stat = "identity", aes(y = count_thousands * alive_prob), 
                  fill = "#b2d7e8", color = "white") + 
  geom_line(aes(y = count_thousands), size = 2)
p <- p + ylab("Number of people (thousands)") + xlab(NULL)
```

We then compute the median age of people that are currently alive and are named Joseph. 
```{r eval = FALSE}
median_yob <- joseph %>% 
  group_by(year) %>% 
  summarise(count = sum(est_alive_today)) %>% 
  mutate(prop = cumsum(count)/sum(count)) %>%
  filter(cumany(prop >= 0.5)) %>% ## a binary earch is more efficient
  select(year) %>% pull() %>% first()
median_yob
```
---
class: clear
We then plot the vertical blue bar depicting the median age of people, currently alive, named Joseph. We annotate the plot by calling $\mathrm{geom\_text}$.
```{r out.width="80%", eval = FALSE}
p <- p + geom_bar(stat = "identity", 
                  aes(y = ifelse(year == median_yob, est_alive_today/1000, 0)),
                  colour = "white", fill = "#008fd5")
p + ggtitle(paste("Age Distribution of American boys named ", name)) +
  geom_text(x = 1935, y = 30, label = "Number of Josephs\nborn each year") +
  geom_text(x = 1915, y = 13, label = "Number of Josephs\nborn each year\nestimated to be alive\non 1/1/2014",color="#b2d7e9") + ylim(0,42) + 
  geom_text(x = 2003, y = 40, label = "The median\nliving Joseph\nis 37 years old", 
            color = "darkgray") + 
  geom_curve(aes(x = 1995, xend = 1974, y =40, yend = 24), 
             arrow = arrow(length = unit(0.3,"cm")), curvature = 0.5) + ylim(0,42) 
```
---
class: clear
Our method for creating the plot object $p$ has a nice side effect in that we can easily update the plot data to get a new plot for a different name, e.g.,
```{r out.width="80%"}
josephine <- filter(BabyNamesDist, name == "Josephine", sex == "F")
p %+% josephine
```
---
class: clear
For even more compelling examples, consider
```{r out.width = "80%"}
p2 <- p + facet_wrap(~ sex)
p2 %+% filter(BabyNamesDist, name == "Jessie")
```
---
class: clear
```{r fig.retina = 4}
p3 <- p + facet_grid(name ~ sex)
p3 %+% filter(BabyNamesDist, name %in% c("Jessie", "Marion", "Jackie"))
```
---
class: clear
We now go back to our original motivation, namely guessing the age of a person given her name. For the $25$ most popular names, we get the following graphic
```{r echo = FALSE, cache = FALSE, out.width="60%", fig.asp = 1.2}
com_fem_names <- BabyNamesDist %>% filter(sex == "F") %>%
  group_by(name) %>%
  summarise(N = n(), 
            est_num_alive = sum(est_alive_today)) %>%
  #          median_age = wtd.quantile(age_today, est_alive_today, probs = 0.5),
  #          q3_age = wtd.quantile(age_today, est_alive_today, probs = 0.75)) %>%
  arrange(desc(est_num_alive)) %>% head(25)

com_fem <- BabyNamesDist %>% filter(sex == "F", name %in% com_fem_names$name) %>%
  group_by(name) %>%
  summarise(est_num_alive = sum(est_alive_today),
            q1_age = Hmisc::wtd.quantile(age_today, est_alive_today, probs = 0.25),
            median_age = Hmisc::wtd.quantile(age_today, est_alive_today, probs = 0.5),
            q3_age = Hmisc::wtd.quantile(age_today, est_alive_today, probs = 0.75)) %>%
  arrange(desc(est_num_alive)) %>% head(25)

p <- ggplot(data = com_fem, aes(x = reorder(name, -median_age)), y = median_age) +
  xlab(NULL) + ylab("Age (in years)") +
  ggtitle("Median ages for females with the 25 most common names") +
  geom_linerange(aes(ymin = q1_age, ymax = q3_age), 
                 color = "#f3d478", size = 10, alpha = 0.8) +
  geom_point(aes(y = median_age), fill = "#ed3324", color = "white", size = 4, shape = 21) +
  geom_point(aes(x = 24, y = 55), fill = "#ed3324", 
             color = "white", size = 4, shape = 21) +
  geom_text(aes(y = 60, x = 24, label = "median")) + 
  geom_text(aes(y = 26, x = 16, label = "25th percentile")) + 
  geom_text(aes(y = 51, x = 16, label = "75th percentile")) +
  geom_point(aes(y = 24, x = 16), shape = 17) +
  geom_point(aes(y = 56, x = 16), shape = 17) + coord_flip()
p
```
---
class: clear
The code to generate the above graphic is as follows. First we find the $25$ most popular female names for people currently alive.
```{r eval = FALSE}
com_fem_names <- BabyNamesDist %>% filter(sex == "F") %>%
  group_by(name) %>%
  summarise(est_num_alive = sum(est_alive_today)) %>%
  arrange(desc(est_num_alive)) %>% head(25)
```
A selection of the most popular names are

```{r echo = FALSE}
knitr::kable(head(com_fem_names))
```
---
class:clear
We then compute the $25$th percentile, the median, and the $75$th percentile for the current age of people with these names. A snippet of the resulting data is given below.
```{r eval = FALSE}
library(Hmisc)
com_fem <- BabyNamesDist %>% filter(sex == "F", name %in% com_fem_names$name) %>%
  group_by(name) %>%
  summarise(est_num_alive = sum(est_alive_today),
            q1_age = wtd.quantile(age_today, est_alive_today, probs = 0.25),
            median_age = wtd.quantile(age_today, est_alive_today, probs = 0.5),
            q3_age = wtd.quantile(age_today, est_alive_today, probs = 0.75)) %>%
  arrange(desc(est_num_alive))
```

```{r echo = FALSE}
knitr::kable(head(com_fem))
```
---
class: clear
The code for plotting the graphic is then simply
```{r eval=FALSE}
p <- ggplot(data = com_fem, aes(x = reorder(name, -median_age)), y = median_age) +
  xlab(NULL) + ylab("Age (in years)") +
  ggtitle("Median ages for females with the 25 most common names") +
  geom_linerange(aes(ymin = q1_age, ymax = q3_age), 
                 color = "#f3d478", size = 10, alpha = 0.8) +
  geom_point(aes(y = median_age), fill = "#ed3324", 
             color = "white", size = 4, shape = 21) +
  geom_point(aes(x = 24, y = 55), fill = "#ed3324", 
             color = "white", size = 4, shape = 21) +
  geom_text(aes(y = 58, x = 24, label = "median")) + 
  geom_text(aes(y = 26, x = 16, label = "25th percentile")) + 
  geom_text(aes(y = 51, x = 16, label = "75th percentile")) +
  geom_point(aes(y = 24, x = 16), shape = 17) +
  geom_point(aes(y = 56, x = 16), shape = 17) + 
  coord_flip() ## coord_flip flips the $x$ and $y$ coordinate
```
---
# Example 3: Temperature trend in Dayton, OH.
We now describe code to generate the graphic we saw earlier about temperature trend in Dayton, OH.

```{r cache = FALSE, echo = FALSE, out.width="80%"}
source("daytona.R")
p <- daytona_plot()
print(p)
```
---
class: clear
The data for this graphic is available as a white-space separated file. We first read the data and rename the columns
```{r}
library(tidyverse)
DAY <- read_table("http://academic.udayton.edu/kissock/http/Weather/gsod95-current/OHDAYTON.txt", col_names = FALSE)
names(DAY) <- c("Month", "Day", "Year", "Temp")
DAY <- select(DAY, "Year", "Month", "Day", "Temp")
knitr::kable(head(DAY))
```
---
class: clear
We then create a data frame that represents historical data during the period from $1995$ to $201$.

```{r cache = FALSE}
NEWDAY <- DAY %>% 
  group_by(Year) %>%
  mutate(newDay = seq(1, length(Day))) %>% #newDay goes from 1 to 365/366 each year
  ungroup()
Past <- NEWDAY %>%
  filter(Temp != -99 & Year != 2014) %>%  ## -99 corresponds to missing observation.
  group_by(newDay) %>% 
  mutate(upper = max(Temp), # identify max value for each day 
         lower = min(Temp), # identify min value for each day 
         avg = mean(Temp),  # calculate mean value for each day 
         se = sd(Temp)/sqrt(length(Temp)), ## standard error
         avg_upper = avg+(2.101*se), ## upper and lower 99% "confidence" interval
         avg_lower = avg-(2.101*se)) %>%  
  ungroup()
```
---
class: clear
We next extract data for the year $2014$. We then create data frames representing the lowest and highest temp for each day of the year for the historical data.
```{r cache = FALSE}
Present <- NEWDAY %>%
  filter(Temp != -99 & Year == 2014)  

# create dataframe that represents the lowest and highest 
# temp for each day for the historical data from 1995 to 2013.
PastRecords <- Past %>%
  group_by(newDay) %>%
  summarise(Pastlow = min(Temp),
            Pasthigh = max(Temp)) 

# create dataframe that identifies the days in 2014 in which the temps were either 
## lower or higher than all previous 19 years
PresentRecords <- Present %>%
  left_join(PastRecords, by = "newDay") %>%  
  mutate(recordlow = ifelse(Temp<Pastlow, "Y", "N"),
         recordhigh = ifelse(Temp > Pasthigh, "Y", "N")) %>% 
  filter(recordlow == "Y" | recordhigh == "Y")  
```
---
class: clear
We first plot the historical data.

```{r cache = FALSE, out.width = "70%"}
p <- ggplot(Past, aes(newDay, Temp)) + 
  theme(plot.background = element_blank(), panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(), panel.border = element_blank(),
        panel.background = element_blank(), axis.ticks = element_blank(),
        axis.title = element_blank()) +
  geom_linerange(Past, mapping=aes(x=newDay, ymin=lower, ymax=upper), 
                 colour = "wheat2", alpha=.1)
p
```
---
class: clear
We next plot the temperature for $2014$ along with the average temperature based on historical data.

```{r cache = FALSE, out.width = "70%"}
p <- p + geom_linerange(Past, mapping=aes(x=newDay, ymin=avg_lower, ymax=avg_upper), 
                        colour = "wheat4")
p <- p +  geom_line(Present, mapping=aes(x=newDay, y=Temp))
p
```
---
class: clear
We then plot the dates (in $2014$) for which the temperature break either the lowest or the highest record.
```{r cache = FALSE, out.width = "70%"}
p <- p + geom_point(data=filter(PresentRecords, recordlow == "Y"), 
                    aes(x=newDay, y=Temp), colour="blue3") +
  geom_point(data=filter(PresentRecords, recordhigh == "Y"), 
             aes(x=newDay, y=Temp), colour="firebrick3")
p
```
---
class: clear
We then setup the axes and labels.
```{r cache= FALSE, out.wdith = "70%"}
p <- p +  geom_vline(xintercept = 0, colour = "wheat4", linetype=1, size=1)
xseq <- c(31,59,90,120,151,181,212,243,273,304,334,365)
for(x in xseq){
  p <- p + geom_vline(xintercept = x, colour = "wheat4", linetype=3, size=.5)
}

dgr_fmt <- function(x, ...) {
  parse(text = paste(x, "*degree", sep = ""))
}

# create y-axis variable
a <- dgr_fmt(seq(-20,100, by=10))

p <- p + coord_cartesian(ylim = c(-20,100)) +
  scale_y_continuous(breaks = seq(-20,100, by=10), labels = a) +
  scale_x_continuous(expand = c(0, 0),
                     breaks=c(15,45,75,105,135,165,195,228,258,288,320,350),
                     labels = c("Jan", "Feb", "Mar", "Apr",
                                "May", "June", "July", "Aug", "Sep",
                                "Oct", "Nov", "Dec"))
```
---
class: clear
The previous code chunk yields the following output. The final output is the obtained by adding $\mathrm{geom\_text}$ commands to generate the annotations.

```{r echo = FALSE}
p
```