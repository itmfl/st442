---
title: "Introduction to Data Science"
subtitle: "Visualizing data with ggplot2"
date: "Fall 2022"
output:
  xaringan::moon_reader:
    lib_dir: libs
    #css: ["default","metropolis","metropolis-fonts","animate.css"]
    css: ["xaringan-themer.css","metropolis-fonts"]
    nature:
      highlightStyle: solarized-light
      highlightLines: false
      highlightSpans: false
      countIncrementalSlides: false
    df_print: tibble
    # css: [default, metropolis, metropolis-fonts]
    # nature:
    #   highlightStyle: zenburn
    #   highlightLines: true
    #   countIncrementalSlides: false
--- 
```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.retina = 3, fig.asp = 0.6, fig.align = 'center', out.width = "120%",message = FALSE,fig.showtext = TRUE)
options(htmltools.dir.version = FALSE, digits = 3, knitr.table.format = "html",tibble.print_min=6, tibble.width=70)
```

```{r xaringan-themer, include = FALSE}
library(xaringanthemer)
library(ggplot2)
library(ggthemes)
theme_set(theme_tufte())
xaringanExtra::use_tile_view()
xaringanExtra::use_scribble()
xaringanExtra::use_extra_styles(hover_code_line = TRUE)
xaringanExtra::use_tachyons()
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
  ),
  rmarkdown::html_dependency_font_awesome()
)
style_duo_accent(primary_color = "#035AA6", secondary_color = "#03A696",
   #title_slide_background_color = "#FFFFFF",
   #title_slide_text_color = "#006747",
   header_font_google = google_font("Josefin Sans"),
   link_color = "#03A696",
   #title_slide_background_size = "600px",
   #title_slide_background_position = "bottom",
   text_font_google   = google_font("Montserrat", "300", "300i"),
   code_font_size = "0.8rem",
   code_font_family = "Fira Code",
   code_font_url = "https://cdn.rawgit.com/tonsky/FiraCode/1.204/distr/fira_code.css"
)
```
#ggplot2
The **ggplot2** package provides a unifying framework and, correspondingly, a grammar for describing and specifying graphics. 

The use of a grammar allows for a coherent system for describing and building graphics using a number of simple and well-defined commands. 

Some useful online resources on on **ggplot2** are
+ The book [ggplot2: Elegant graphics for data analysis](https://ggplot2-book.org) by H. Wickham.

+ The book [Data Visualization](https://socviz.co/) by K. Healy.

+ The [R Graphics Cookbook](https://r-graphics.org) by W. Chang.

+ The [R Studio ggplot2 cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)

---
class: clear

As an example, the following figure was generated using data from the average daily temperature archive at the [University of Dayton](http://academic.udayton.edu/kissock/http/Weather/).

```{r echo = FALSE, cache = TRUE, warning = FALSE, message = FALSE, fig.retina = 4, fig.align = 'center', out.width="120%", fig.asp = 0.6}
source("R_scripts/dayton.R")
p <- daytona_plot()
print(p)
```
---
class: clear
As another example, consider the following famous plot of Charles Minard on Napoleon's 1812 winter retreat from Moscow. During this excursion, the Grande Armee dropped from $422000$ to $10000$ troops.

```{r echo = FALSE}
knitr::include_graphics("figures/Minard.png")
```
---
class: clear
A **R** version generated by **ggplot2** is below; the code is from Andrew Heiss [blog post](https://www.andrewheiss.com/blog/2017/08/10/exploring-minards-1812-plot-with-ggplot2/).

```{r, echo = FALSE, cache = TRUE, warning = FALSE, message = FALSE, fig.retina = 4, out.width = "120%", fig.asp = 0.5}
source("napoleon_fig/napoleon_fig.R")
p <- napoleon_plot()
grid::grid.newpage()
grid::grid.draw(p)
```

Close, but no cigar ? In any case, the above plot is nice in that a total of six variables are mapped to six *aesthetics*; $x$ and $y$ axis mapped to the location of the army, the size of the army is mapped to the size of the line, the direction of movement is mapped to color, date of points along retreat path is mapped to the text below plot, and the temperature during the retreat is mapped to the line below the plot.
---
#ggplot2 basic
We start with a very simple plot. Consider the following dataset about fuel efficiency for cars.

```{r echo = -2, fig.align = 'center', out.width = "50%"}
library(ggplot2)
data(mpg)
dplyr::select(mpg, -fl, -class)
```
---
```{r mpg}
library(ggplot2)
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + 
  geom_point()
```

---
class: clear
We next color the cars based on its class (e.g., compact vs suv vs pickup)
```{r fig.align = 'center', out.width = "80%", fig.asp = 0.6, fig.retina = 3}
p <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, color = class)) + 
  xlab("Engine Size") + ylab("Highway mile per gallon")
p
```
---
class: clear
Compare the previous plot with the following two plots.
```{r fig.align = 'center', fig.asp = 0.4, message = FALSE, fig.retina = 3, out.width = "120%", warning = FALSE}
p1 <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, size = class))
p2 <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, alpha = class))
## The gridExtra library is nice for showing multiple figures in a panel.
require(gridExtra) 
grid.arrange(p1,p2,ncol = 2)
```
---
#aes()
We see that the plots differ in which aesthetic the variable *class* is mapped to, e.g., color vs size vs alpha translucency.

A variable can be mapped to a number of different aesthetics; the choice of aesthetics also depend on the *geom\_function* that is used. For example, $\mathrm{geom\_point}$ understands the following aesthetics
+ $x$ and $y$ for coordinates (required)
+ $\mathrm{alpha}$, $\mathrm{color}$, $\mathrm{fill}$ for color and shade.
+ $\mathrm{size}$, $\mathrm{shape}$ and $\mathrm{stroke}$.
+ $\mathrm{group}$ (not used?)

In contrasts, $\mathrm{geom\_line}$ understands the following aesthetics
+ $x$ and $y$ (required)
+ $\mathrm{alpha}$ and $\mathrm{color}$
+ $\mathrm{linetype}$ and $\mathrm{size}$
+ $\mathrm{group}$ (use to draw multiple lines, one for each group)
---
class: clear
We can also set an aesthetic manually, i.e., does not map it to a variable, by setting the aesthetic to a constant outside of the $\mathrm{aes()}$ call, e.g.,
```{r out.width = "80%", fig.asp = 0.6, fig.retina = 3}
ggplot(mpg) + 
  geom_point(aes(x = displ, y = hwy), color = "blue", shape = 24)
```
---
#facet
We can also introduce additional (categorical) variables through faceting, i.e., 

+ split your data into groups 
+ display different subplots (but using the same [geom](https://ggplot2.tidyverse.org/reference)) for each subgroups. 

```{r facet1, fig.align = 'center', out.width = "60%"}
ggplot(data = mpg) + 
  geom_point(aes(x = displ, y = hwy, col = cyl)) +
  facet_wrap(~class, nrow = 2)
```
---
class: clear
We can also facet our plots using a combination of two (categorical) variables
```{r, fig.align = 'center', out.width = "80%", fig.asp = 0.6, fig.retina = 3}
ggplot(data = mpg) + 
  geom_point(aes(x = displ, y = hwy, col = cyl)) +
  facet_grid(drv ~ cyl)
```
---
#Geometric objects

Consider the following three plots. Each plot uses the same $x$ and $y$ coordinates, but different *geoms* or geometric objects.

```{r, out.width = "100%", fig.show = 'hold', fig.asp = 0.4}
p <- ggplot(data = mpg, aes(x = displ, y = hwy))
p1 <- p + geom_point() + ggtitle("Plot 1")
p2 <- p + geom_smooth() + ggtitle("Plot 2")
p3 <- p + geom_point() + geom_smooth() + ggtitle("Plot 3")
grid.arrange(p1,p2,p3, ncol = 3)
```
---
class: clear
Compare also the following two plots.
```{r, fig.asp = 0.5}
p <- ggplot(data = mpg, mapping = aes(x = displ, y = hwy))
p1 <- p + geom_point(aes(color = drv))
p2 <- p + geom_smooth(aes(color = drv))
grid.arrange(p1,p2,ncol = 2)
```
---
class: clear
Finally, each geom object can also use different data set.
```{r out.width = "80%"}
ggplot(mpg, mapping = aes(x = displ, y = hwy)) +
  geom_point(aes(color = class), show.legend = FALSE) + 
  geom_smooth(data = dplyr::filter(mpg, class == "subcompact"))
```

---
#Polished graphics
Plots generated from *ggplot2* is reasonably polished, but a little touches here and there can make these graphics even better. We illustrate this by visualizing the temperature anomaly pattern in Berkeley, CA.
```{r cache = TRUE}
library(gcookbook) # Load gcookbook for the climate data set
library(dplyr)

climate_sub <- climate %>%
  filter(Source == "Berkeley" & Year >= 1900) %>%
  mutate(pos = Anomaly10y >= 0) %>% as_tibble()

climate_sub
```
---
class: clear
```{r cache = TRUE, out.width = "70%"}
p <- ggplot(climate_sub, aes(x = Year, y = Anomaly10y, fill = pos))
p + geom_col()
```

This figure looks fine but the color are "reversed" and the legend is redundant and distracting.
---
class: clear
```{r cache = TRUE, out.width = "70%"}
p + geom_col(colour = "black", size = 0.25) +
  scale_fill_manual(values = c("#CCEEFF", "#FFDDDD"), guide = FALSE)
```
---
# Example 1: US Gun Murders
We now present a few more sophisticated examples of **ggplot2** output. 
```{r cache = TRUE, echo = TRUE}
## The package dslabs accompanies the book 
## Introduction to Data Science @ https://rafalab.github.io/dsbook/
library(dslabs)
data(murders)
murders
```
---
class: clear, middle
We start with the most naive plot. This plot exhibits an undesirable property in that there are a few points that are far from the remaining points (states with large population and a lot of murders)
```{r cache = TRUE, out.width = "80%"}
p <- ggplot(murders, aes(x = population/10^6, y = total)) + 
  geom_point()
p
```
---
class: clear, middle
We remedy the above situation by plotting on a $\log$ $\log$ scale.
```{r cache = TRUE, out.width = "80%"}
p <- p + scale_x_continuous(trans = "log10") +
         scale_y_continuous(trans = "log10")
p
```
---
class: clear, middle
We now add text labels.
```{r cache = TRUE, out.width = "80%"}
p + geom_text(aes(label = abb))
```
---
class: clear, middle
The previous output looks quite a bit ugly as the text is all jumbled up with the data points. We can adjust this by nudging the labels slightly.
```{r cache = TRUE, out.width = "80%"}
p + geom_text(aes(label = abb), nudge_x = 0.1)
```
---
class: clear, middle
The output is not really improved. So we give up and call in the [big guns](https://cran.r-project.org/web/packages/ggrepel).
```{r cache = TRUE, out.width = "80%"}
library(ggrepel)
p + geom_text_repel(aes(label = abb))
```
---
class: clear, middle
A few more polishing touches yield the following output

```{r cache = TRUE, plot-label-out, ref.label = "plot-label", out.width = "80%", echo = FALSE}
```

---
class: clear, middle
The code generating the previous plot is

```{r plot-label, eval = FALSE}
library(ggthemes)
p <- ggplot(murders, aes(x = population/10^6, y = total)) +
  geom_point(aes(col = region), size = 3) + 
  geom_text_repel(aes(label = abb)) +
  scale_x_log10() + scale_y_log10() +
  xlab("Population in millions (log scale)") + 
  ylab("Murders (log scale)") + 
  ggtitle("US Gun Murders in 2010") + 
  scale_color_discrete(name = "Region") + 
  geom_smooth(method = "lm", se = FALSE) +
  theme_economist()
p
```

---
# Example 2: Weather trends
```{r cache = TRUE, echo = FALSE, out.width="80%"}
source("R_scripts/daytona.R")
p <- daytona_plot()
print(p)
```
---
class: clear, middle
We now describe code to generate the graphic we saw earlier about temperature trend in Dayton, OH. The original code is from [Brad Boehmke](https://rpubs.com/bradleyboehmke/weather_graphic) and is an attempt to reproduce a well-known visualization from Eward Tufte's classic book [Visual display of quantitative information](https://www.edwardtufte.com/tufte/books_vdqi).

The data for this graphic is available as a white-space separated file. We first read the data and rename the columns
```{r cache = TRUE}
library(readr)
DAY <- read_table("https://bit.ly/2NGLI7N", col_names = FALSE)
names(DAY) <- c("Month", "Day", "Year", "Temp")
DAY <- select(DAY, "Year", "Month", "Day", "Temp")
DAY
```
---
class: clear
We then create a data frame of the historical data from $1995$ to $2013$.

```{r cache = TRUE}
NEWDAY <- DAY %>% 
  group_by(Year) %>%
  mutate(newDay = seq(1, length(Day))) %>% 
  ungroup()
## In the above output newDay goes from 1 to 365/366 each year

Past <- NEWDAY %>%
  filter(Temp != -99 & Year != 2014) %>%  #-99 is missing
  group_by(newDay) %>% 
  mutate(upper = max(Temp), # identify max value for each day 
         lower = min(Temp), # identify min value for each day 
         avg = mean(Temp),  # calculate mean value for each day 
         se = sd(Temp)/sqrt(length(Temp)),  # standard error
         avg_upper = avg+(2.101*se), # 99% "confidence" interval
         avg_lower = avg-(2.101*se)) %>%  ungroup()
```
---
class: clear
```{r cache = TRUE}
Past
filter(Past, newDay == 1)
```
---
class: clear
We next extract data for the year $2014$. We then create data frames representing the lowest and highest temp for each day of the year for the historical data.
```{r cache = TRUE}
Present <- NEWDAY %>%
  filter(Temp != -99 & Year == 2014)  

# create dataframe that represents the lowest and highest 
# temp for each day for the historical data from 1995 to 2013.
PastRecords <- Past %>% 
  group_by(newDay) %>%
  summarise(Pastlow = min(Temp),
            Pasthigh = max(Temp)) 

## create dataframe that identifies the days in 2014 in which temps 
## were either lower or higher than all previous 19 years.
PresentRecords <- Present %>%
  left_join(PastRecords, by = "newDay") %>%  
  mutate(recordlow = ifelse(Temp<Pastlow, "Y", "N"),
         recordhigh = ifelse(Temp > Pasthigh, "Y", "N")) %>% 
  filter(recordlow == "Y" | recordhigh == "Y")  
```
---
class: clear
We first plot the historical data.

```{r cache = TRUE, out.width = "70%"}
p <- ggplot(Past, mapping=aes(newDay, Temp)) + 
  theme(plot.background = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(), 
        panel.border = element_blank(),
        panel.background = element_blank(), 
        axis.ticks = element_blank(), axis.title = element_blank()) +
  geom_linerange(Past, 
                 mapping=aes(x=newDay, ymin=lower, ymax=upper), 
                 colour = "wheat2", alpha=.1)
p
```
---
class: clear
We next plot the temperature for $2014$ along with the average temperature based on historical data.

```{r cache = TRUE, out.width = "70%"}
p <- p + geom_linerange(Past, 
                        mapping=aes(x=newDay, ymin=avg_lower, 
                                    ymax=avg_upper), 
                        colour = "wheat4")
p <- p +  geom_line(Present, mapping=aes(x=newDay, y=Temp))
p
```
---
class: clear
We then plot the dates (in $2014$) for which the temperature break either the lowest or the highest record.
```{r cache = TRUE, out.width = "70%"}
p <- p + geom_point(data=filter(PresentRecords, recordlow == "Y"), 
                    aes(x=newDay, y=Temp), colour="blue3") +
  geom_point(data=filter(PresentRecords, recordhigh == "Y"), 
             aes(x=newDay, y=Temp), colour="firebrick3")
p
```
---
class: clear
We then setup the axes and labels.
```{r cache= TRUE, out.width = "70%"}
p <- p +  geom_vline(xintercept = 0, colour = "wheat4", 
                     linetype=1, size=1)
xseq <- c(31,59,90,120,151,181,212,243,273,304,334,365)
for(x in xseq){
  p <- p + geom_vline(xintercept = x, colour = "wheat4", 
                      linetype=3, size=.5)
}

dgr_fmt <- function(x, ...) {
  parse(text = paste(x, "*degree", sep = ""))
}

# create y-axis variable
a <- dgr_fmt(seq(-20,100, by=10))

p <- p + coord_cartesian(ylim = c(-20,100)) +
  scale_y_continuous(breaks = seq(-20,100, by=10), labels = a) +
  scale_x_continuous(expand = c(0, 0),
                     breaks=c(15,45,75,105,135,165,195,
                              228,258,288,320,350),
                     labels = c("Jan", "Feb", "Mar", "Apr",
                                "May", "June", "July", "Aug", "Sep",
                                "Oct", "Nov", "Dec"))
```
---
class: clear
The previous code chunk yields the following output. 

```{r cache = TRUE, echo = FALSE}
p
```
---
class: clear
Final output is obtained by adding $\mathrm{annotate}$ commands for the annotations.
```{r cache = TRUE}
p <- p +
  ggtitle("Dayton's Weather in 2014") +
  theme(plot.title=element_text(face="bold",hjust=.012,vjust=.8,
                                colour="#3C3C3C",size=20)) +
  annotate("text", x = 119, y = 98, label = "Temperature", 
           size=4, fontface="bold")

p <- p +
  annotate("text", x = 126, y = 93,
           label = paste("Data represents average daily",
                         "temperatures. Accessible data dates",
                         "back to"),
           size=3, colour="gray30") +
  annotate("text", x = 122, y = 89,
           label = paste("January 1, 1995. Data for 2014 is",
                         "only available through December 16."), 
           size=3, colour="gray30") +
  annotate("text", x = 124, y = 85,
           label = paste("Average temperature for the year was",
                         "51.9° making 2014 the 9th coldest"),
           size=3, colour="gray30") +
  annotate("text", x = 128, y = 81, label = "year since 1995",
           size=3, colour="gray30")
```
---
class: clear, middle
```{r}
p <- p +
  annotate("segment", x = 30, xend = 40, y = -5, 
           yend = -10, colour = "blue3") +
  annotate("text", x = 65, y = -10, 
           label = "We had 35 days that were the", 
           size=3, colour="blue3") +
  annotate("text", x = 56, y = -14, 
           label = "coldest since 1995", 
           size=3, colour="blue3") +
  annotate("segment", x = 302, xend = 307, y = 74, 
           yend = 82, colour = "firebrick3") +
  annotate("text", x = 333, y = 92, 
           label = "We had 19 days that were the", 
           size=3, colour="firebrick3") +
  annotate("text", x = 324, y = 88, 
           label = "hottest since 1995", 
           size=3, colour="firebrick3")
```
---
class: clear
```{r cache = TRUE, echo = FALSE}
p
```
