<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Introduction to Data Science</title>
    <meta charset="utf-8" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/metropolis-fonts.css" rel="stylesheet" />
    <link href="libs/tile-view/tile-view.css" rel="stylesheet" />
    <script src="libs/tile-view/tile-view.js"></script>
    <script src="libs/fabric/fabric.min.js"></script>
    <link href="libs/xaringanExtra-scribble/scribble.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-scribble/scribble.js"></script>
    <script>document.addEventListener('DOMContentLoaded', function() { window.xeScribble = new Scribble({"pen_color":["#FF0000"],"pen_size":3,"eraser_size":30,"palette":[]}) })</script>
    <link href="libs/xaringanExtra-extra-styles/xaringanExtra-extra-styles.css" rel="stylesheet" />
    <link href="libs/tachyons/tachyons.min.css" rel="stylesheet" />
    <script src="libs/clipboard/clipboard.min.js"></script>
    <link href="libs/xaringanExtra-clipboard/xaringanExtra-clipboard.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-clipboard/xaringanExtra-clipboard.js"></script>
    <script>window.xaringanExtraClipboard(null, {"button":"<i class=\"fa fa-clipboard\"><\/i>","success":"<i class=\"fa fa-check\" style=\"color: #90BE6D\"><\/i>","error":"Press Ctrl+C to Copy"})</script>
    <link href="libs/font-awesome/css/all.min.css" rel="stylesheet" />
    <link href="libs/font-awesome/css/v4-shims.min.css" rel="stylesheet" />
    <script src="libs/kePrint/kePrint.js"></script>
    <link href="libs/lightable/lightable.css" rel="stylesheet" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Introduction to Data Science
]
.subtitle[
## Tidyr and relational data
]
.date[
### Fall 2021
]

---









#Tidy Data
Consider the following four different representations of the same data.


.pull-left[
&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
&lt;caption style="font-size: initial !important;"&gt;Table 1&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; year &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; cases &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; population &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 745 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.00e+07 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2666 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.06e+07 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 37737 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.72e+08 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 80488 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.75e+08 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 212258 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.27e+09 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 213766 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.28e+09 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]
.pull-right[
&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
&lt;caption style="font-size: initial !important;"&gt;Table 2&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; year &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; type &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; value &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; cases &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 7.45e+02 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; population &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.00e+07 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; cases &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.67e+03 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; population &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.06e+07 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; cases &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3.77e+04 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; population &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.72e+08 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; cases &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 8.05e+04 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; population &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.75e+08 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; cases &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.12e+05 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; population &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.27e+09 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; cases &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.14e+05 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; population &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.28e+09 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]
---
class: clear, middle
.pull-left[
&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
&lt;caption style="font-size: initial !important;"&gt;Table 3&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; year &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; rate &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 745/19987071 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2666/20595360 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 37737/172006362 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 80488/174504898 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 212258/1272915272 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 213766/1280428583 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]
.pull-right[
&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
&lt;caption style="font-size: initial !important;"&gt;Table 4a&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; 1999 &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; 2000 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 745 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2666 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 37737 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 80488 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 212258 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 213766 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
&lt;caption style="font-size: initial !important;"&gt;Table 4b&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; 1999 &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; 2000 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.00e+07 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.06e+07 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.72e+08 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.75e+08 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.27e+09 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.28e+09 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]

---
class: middle

The above tables represent the same data with quite different characteristics. 

+ For example, table `\(4a\)` provides the simplest way for finding the difference in the number of cases between `\(1999\)` and `\(2000\)`. 

+ Table `\(1\)` is the easiest table to add new variables such as 
`\(\mathrm{GDP}\)`. 

+ Table `\(3\)` is not particularly suitable for data analysis, 
but is possibly useful for data collection. 

+ Table `\(2\)` is appropriate if the columns of Table `\(1\)`, instead of being *cases* and *populations*, are e.g., 
diseases such as *diabetes*, *HIV*, *colon cancer*, ... for which there is possibly 
missing/unobserved data (that is not all diseases are surveyed for every country). 

---
#pivoting

There is often a need to transform data between two different representations 
exemplified by Table `\(1\)` and Table `\(2\)` in the previous slide. 

The main tool for doing so are the verbs [pivot_longer](https://tidyr.tidyverse.org/reference/pivot_longer.html) and [pivot_wider](https://tidyr.tidyverse.org/reference/pivot_wider.html) that are part of 
the [tidyr](https://tidyr.tidyverse.org/index.html) library.  

For the motivations behind **tidyr** see the article [Tidy Data](https://www.jstatsoft.org/article/view/v059i10) by Hadley Wickham. 

See also the data tyding [cheatsheet](https://raw.githubusercontent.com/rstudio/cheatsheets/master/tidyr.pdf) from **Rstudio**.

--

To convert from Table `\(1\)` to Table `\(2\)`, we do

```r
table2 &lt;- pivot_longer(data = table1, cols = c("cases","population"), 
                       names_to = "type", values_to = "value")
## Equivalently
## pivot_longer(table1, c("cases","population"), "type", "value")
```

--

Conversely, to convert from Table `\(2\)` to Table `\(1\)`, we do

```r
table1 &lt;- pivot_wider(table2, names_from = type, values_from = count)
```


---
class: clear
As another example, consider the following two representations of table `\(4a\)`.
.pull-left[
&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
&lt;caption style="font-size: initial !important;"&gt;table4a&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; 1999 &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; 2000 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 745 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2666 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 37737 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 80488 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 212258 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 213766 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]
.pull-right[
&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
&lt;caption style="font-size: initial !important;"&gt;table4a_new&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; year &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; cases &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 745 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2666 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 37737 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 80488 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 212258 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 213766 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]

&lt;br&gt;
To go from the first representation to the second representation, we do

```r
table4a_new &lt;- table4a %&gt;% pivot_longer(cols = c("1999","2000"), 
                                        names_to = "year", values_to = "cases")
```
and to go from the second representation to the first, we do

```r
table4a_new %&gt;% pivot_wider(names_from = "year", values_from = "cases") 
```
---
# Missing data and pivoting.
In our previous examples we see that **pivot_longer** and **pivot_wider** behave like inverse operations of one another. This is not always the case.

Consider the following contrived dataset.

```r
stocks
```

```
## # A tibble: 7 × 3
##    year quarter return
##   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
## 1  2015       1   1.88
## 2  2015       2   0.59
## 3  2015       3   0.35
## 4  2015       4  NA   
## 5  2016       2   0.92
## 6  2016       3   0.17
## 7  2016       4   2.66
```

How many observations are missing in the above data ? 
+ The observation for the `\(4\)`th quarter of `\(2015\)` is *explicitly* missing
+ The observation for the `\(1\)`st quarter of `\(2016\)` is *implicitly* missing.
---
class: clear
**pivot_longer** the `stocks` dataset and then **pivot_wider** the resulting data yields
.pull-left[

```r
stocks_wide &lt;- stocks %&gt;% 
  pivot_wider(names_from = "year", 
              values_from = "return")
stocks_wide
```

```
## # A tibble: 4 × 3
##   quarter `2015` `2016`
##     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1       1   1.88  NA   
## 2       2   0.59   0.92
## 3       3   0.35   0.17
## 4       4  NA      2.66
```
]
.pull-right[

```r
stocks_wide %&gt;% 
  pivot_longer(cols = c("2015",
                        "2016"),
               names_to = "year",
               values_to = "return")
```

```
## # A tibble: 8 × 3
##   quarter year  return
##     &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
## 1       1 2015    1.88
## 2       1 2016   NA   
## 3       2 2015    0.59
## 4       2 2016    0.92
## 5       3 2015    0.35
## 6       3 2016    0.17
## 7       4 2015   NA   
## 8       4 2016    2.66
```
]

---
#NAs: complete() and fill()
To make missing values explicit, you can use the function [complete](https://tidyr.tidyverse.org/reference/complete.html). 

+ The function takes as input a set of columns
+ It then finds all unique combinations of their values 
+ Then ensures that the original dataset contains all these combinations by filling in explicit `NA`

There are also occasions in which a missing value is not really missing; instead a missing value indicate that the previous value should be carried forward.

+ This is common when data are generated via manual data entry.
+ We can  use [fill](https://tidyr.tidyverse.org/reference/fill.html) to replace `NA` with the most recent non-`NA` value.

.pull-left[

```r
treatment &lt;- tribble(
  ~person, ~treatment, ~response,
  "Luigi", 0, 7,
  NA, NA, 10,
  NA, 1, 9,
  "Mario", 1, 4
)
```
]
.pull-right[

```r
treatment %&gt;% fill(person,treatment)
```

```
## # A tibble: 4 × 3
##   person treatment response
##   &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 Luigi          0        7
## 2 Luigi          0       10
## 3 Luigi          1        9
## 4 Mario          1        4
```
]
---
#separate() and unite()
We recall the following two tables

.pull-left[

```r
table1
```

```
## # A tibble: 6 × 4
##   country      year  cases population
##   &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;
## 1 Afghanistan  1999    745   19987071
## 2 Afghanistan  2000   2666   20595360
## 3 Brazil       1999  37737  172006362
## 4 Brazil       2000  80488  174504898
## 5 China        1999 212258 1272915272
## 6 China        2000 213766 1280428583
```
]
.pull-right[

```r
table3
```

```
## # A tibble: 6 × 3
##   country      year rate             
##   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;            
## 1 Afghanistan  1999 745/19987071     
## 2 Afghanistan  2000 2666/20595360    
## 3 Brazil       1999 37737/172006362  
## 4 Brazil       2000 80488/174504898  
## 5 China        1999 212258/1272915272
## 6 China        2000 213766/1280428583
```
]

&lt;br&gt;
Table `\(3\)` is obtained by combining the columns `cases` and `populations` in Table `\(1\)` into the column `rate` and separating the values with `/`. 

Note that the `rate` column has type `\(\langle\mathrm{chr}\rangle\)` in contrast to the type of `\(\langle \mathrm{dbl} \rangle\)` for `cases` and `populations`.
---
class: clear

To go from Table `\(3\)` to Table `\(1\)`, we do either

.pull-left[

```r
table3 %&gt;% 
  separate(rate, 
          into=c("cases",
                 "population"), 
          sep = "/")
```

```
## # A tibble: 6 × 4
##   country      year cases  population
##   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;     
## 1 Afghanistan  1999 745    19987071  
## 2 Afghanistan  2000 2666   20595360  
## 3 Brazil       1999 37737  172006362 
## 4 Brazil       2000 80488  174504898 
## 5 China        1999 212258 1272915272
## 6 China        2000 213766 1280428583
```
]

.pull-right[

```r
table3 %&gt;% 
  separate(rate, 
           into=c("cases",
                  "population"), 
           sep = "/", convert = TRUE)
```

```
## # A tibble: 6 × 4
##   country      year  cases population
##   &lt;chr&gt;       &lt;dbl&gt;  &lt;int&gt;      &lt;int&gt;
## 1 Afghanistan  1999    745   19987071
## 2 Afghanistan  2000   2666   20595360
## 3 Brazil       1999  37737  172006362
## 4 Brazil       2000  80488  174504898
## 5 China        1999 212258 1272915272
## 6 China        2000 213766 1280428583
```
]
---
class: clear
The inverse of [separate](https://tidyr.tidyverse.org/reference/separate.html) is [unite](https://tidyr.tidyverse.org/reference/unite.html), e.g.,
&lt;br&gt;
.pull-left[

```r
table1 %&gt;% 
  unite(rate, cases, population)
```

```
## # A tibble: 6 × 3
##   country      year rate             
##   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;            
## 1 Afghanistan  1999 745_19987071     
## 2 Afghanistan  2000 2666_20595360    
## 3 Brazil       1999 37737_172006362  
## 4 Brazil       2000 80488_174504898  
## 5 China        1999 212258_1272915272
## 6 China        2000 213766_1280428583
```
]

.pull-right[

```r
table1 %&gt;% 
  unite(rate, cases, population,
        sep = "/")
```

```
## # A tibble: 6 × 3
##   country      year rate             
##   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;            
## 1 Afghanistan  1999 745/19987071     
## 2 Afghanistan  2000 2666/20595360    
## 3 Brazil       1999 37737/172006362  
## 4 Brazil       2000 80488/174504898  
## 5 China        1999 212258/1272915272
## 6 China        2000 213766/1280428583
```
]
---
# Example 1: Tidying tuberculosis

For this example we use the following dataset from the `\(2014\)` World Health Organization (WHO) Global Tubercolosis Report. This dataset records the number of cases of tubercolosis in countries around the world during the period of `\(1980\)` through `\(2013\)`. 

```r
who
```

```
## # A tibble: 7,240 × 60
##   country     iso2  iso3   year new_sp_m014 new_sp_m1524 new_sp_m2534
##   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
## 1 Afghanistan AF    AFG    1980          NA           NA           NA
## 2 Afghanistan AF    AFG    1981          NA           NA           NA
## 3 Afghanistan AF    AFG    1982          NA           NA           NA
## 4 Afghanistan AF    AFG    1983          NA           NA           NA
## 5 Afghanistan AF    AFG    1984          NA           NA           NA
## 6 Afghanistan AF    AFG    1985          NA           NA           NA
## # ℹ 7,234 more rows
## # ℹ 53 more variables: new_sp_m3544 &lt;dbl&gt;, new_sp_m4554 &lt;dbl&gt;,
## #   new_sp_m5564 &lt;dbl&gt;, new_sp_m65 &lt;dbl&gt;, new_sp_f014 &lt;dbl&gt;,
## #   new_sp_f1524 &lt;dbl&gt;, new_sp_f2534 &lt;dbl&gt;, new_sp_f3544 &lt;dbl&gt;,
## #   new_sp_f4554 &lt;dbl&gt;, new_sp_f5564 &lt;dbl&gt;, new_sp_f65 &lt;dbl&gt;,
## #   new_sn_m014 &lt;dbl&gt;, new_sn_m1524 &lt;dbl&gt;, new_sn_m2534 &lt;dbl&gt;,
## #   new_sn_m3544 &lt;dbl&gt;, new_sn_m4554 &lt;dbl&gt;, new_sn_m5564 &lt;dbl&gt;, …
```
---
class: clear
The dataset contains quite a lot of redundant columns and missing observations. 

Also, the numerous columns whose names start with `new` indicate that these columns' names should be recorded as values as opposed to being variables names.

We thus start by pivoting the data to a longer format.

```r
who1 &lt;- who %&gt;% 
  select(-iso2,-iso3) %&gt;%
  pivot_longer(col = -c("country","year"), names_to = "code", 
               values_to = "cases", values_drop_na = TRUE)
who1
```

```
## # A tibble: 76,046 × 4
##   country      year code         cases
##   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;
## 1 Afghanistan  1997 new_sp_m014      0
## 2 Afghanistan  1997 new_sp_m1524    10
## 3 Afghanistan  1997 new_sp_m2534     6
## 4 Afghanistan  1997 new_sp_m3544     3
## 5 Afghanistan  1997 new_sp_m4554     5
## 6 Afghanistan  1997 new_sp_m5564     2
## # ℹ 76,040 more rows
```
---
class: clear

```r
who1 %&gt;% count(code) %&gt;% select(code) %&gt;% pull()
```

```
##  [1] "new_ep_f014"  "new_ep_f1524" "new_ep_f2534" "new_ep_f3544" "new_ep_f4554"
##  [6] "new_ep_f5564" "new_ep_f65"   "new_ep_m014"  "new_ep_m1524" "new_ep_m2534"
## [11] "new_ep_m3544" "new_ep_m4554" "new_ep_m5564" "new_ep_m65"   "new_sn_f014" 
## [16] "new_sn_f1524" "new_sn_f2534" "new_sn_f3544" "new_sn_f4554" "new_sn_f5564"
## [21] "new_sn_f65"   "new_sn_m014"  "new_sn_m1524" "new_sn_m2534" "new_sn_m3544"
## [26] "new_sn_m4554" "new_sn_m5564" "new_sn_m65"   "new_sp_f014"  "new_sp_f1524"
## [31] "new_sp_f2534" "new_sp_f3544" "new_sp_f4554" "new_sp_f5564" "new_sp_f65"  
## [36] "new_sp_m014"  "new_sp_m1524" "new_sp_m2534" "new_sp_m3544" "new_sp_m4554"
## [41] "new_sp_m5564" "new_sp_m65"   "newrel_f014"  "newrel_f1524" "newrel_f2534"
## [46] "newrel_f3544" "newrel_f4554" "newrel_f5564" "newrel_f65"   "newrel_m014" 
## [51] "newrel_m1524" "newrel_m2534" "newrel_m3544" "newrel_m4554" "newrel_m5564"
## [56] "newrel_m65"
```

--
The columns whose names begin with `\(\mathrm{new}\)` has the following interpretation.

+ `\(\mathrm{new}\)` denote that the column contains new cases of TB.
+ The next `\(2\)` or `\(3\)` letters describe the type of TB, namely
    - `\(\mathrm{rel}\)` for relapse
    - `\(\mathrm{ep}\)` for extrapulmonary TB
    - `\(\mathrm{sn}\)` for pulmonary TB that are smear negative.
    - `\(\mathrm{sp}\)` for pulmonary TB that are smear positive.
+ `\(\mathrm{m}\)` and `\(\mathrm{f}\)` denote gender.
+ The numbers denote the age group/age range.

---
class: middle

We note that the relapse cases are coded as `newrel` as opposed to `new_rel` like the remaining cases. 

We thus rename `newrel` to `new_rel` and then separate the `code` column into four columns according to the above scheme. 

Note that we call **separate** twice; the second separate splits at a specified location in the string.

```r
who2 &lt;- who1 %&gt;% 
  mutate(key = stringr::str_replace(code, "newrel", "new_rel")) %&gt;%
  separate(code, into = c("new", "type", "sexage")) %&gt;%
  select(-new) %&gt;%
  separate(sexage, into = c("sex", "age"), sep = 1)
```
---
class: clear

```r
who2
```

```
## # A tibble: 76,046 × 7
##   country      year type  sex   age   cases key         
##   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;       
## 1 Afghanistan  1997 sp    m     014       0 new_sp_m014 
## 2 Afghanistan  1997 sp    m     1524     10 new_sp_m1524
## 3 Afghanistan  1997 sp    m     2534      6 new_sp_m2534
## 4 Afghanistan  1997 sp    m     3544      3 new_sp_m3544
## 5 Afghanistan  1997 sp    m     4554      5 new_sp_m4554
## 6 Afghanistan  1997 sp    m     5564      2 new_sp_m5564
## # ℹ 76,040 more rows
```

The data is now in a tidy format. In summary, we did

```r
who_tidy &lt;- who %&gt;% 
  pivot_longer(cols = 5:60, names_to = "code", 
               values_to = "cases", values_drop_na = TRUE) %&gt;%
  mutate(code = stringr::str_replace(key, "newrel", "new_rel")) %&gt;%
  separate(code, into = c("new", "type", "sexage")) %&gt;% 
  select(-new, -iso2, -iso3) %&gt;%
  separate(sexage, into = c("sex", "age"), sep = 1)
```
---
#Example 2: Names and gender
As another example of the use of **pivot_longer()** and **pivot_wider()**, 
suppose we want to summarize the number of people with a given name based on gender.


```r
library(babynames)
babynames
```

```
## # A tibble: 1,924,665 × 5
##    year sex   name          n   prop
##   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;     &lt;int&gt;  &lt;dbl&gt;
## 1  1880 F     Mary       7065 0.0724
## 2  1880 F     Anna       2604 0.0267
## 3  1880 F     Emma       2003 0.0205
## 4  1880 F     Elizabeth  1939 0.0199
## 5  1880 F     Minnie     1746 0.0179
## 6  1880 F     Margaret   1578 0.0162
## # ℹ 1,924,659 more rows
```
---
class: clear
.pull-left[

```r
library(babynames)
babynames %&gt;% 
  filter(name == "Sue") %&gt;%
  group_by(name, sex) %&gt;% 
  summarise(total = sum(n))
```

```
## # A tibble: 2 × 3
##   name  sex    total
##   &lt;chr&gt; &lt;chr&gt;  &lt;int&gt;
## 1 Sue   F     144465
## 2 Sue   M        519
```
]

.pull-right[

```r
library(babynames)
babynames %&gt;% 
  filter(name == "Robin") %&gt;%
  group_by(name, sex) %&gt;% 
  summarise(total = sum(n))
```

```
## # A tibble: 2 × 3
##   name  sex    total
##   &lt;chr&gt; &lt;chr&gt;  &lt;int&gt;
## 1 Robin F     289395
## 2 Robin M      44616
```
]

We see that a person named "Sue" is most likely to be female while a person name "Robin" could have reasonable chances of being either male or female.

---
class: clear

If we now take a collection of names, and look at the number of people with these names based on gender, we might get either

.pull-left[

```r
names &lt;- c("Sue", "Robin", "Leslie")
babynames %&gt;% 
  filter(name %in% names) %&gt;%
  group_by(name, sex) %&gt;%
  summarise(total = sum(n))
```

```
## # A tibble: 6 × 3
##   name   sex    total
##   &lt;chr&gt;  &lt;chr&gt;  &lt;int&gt;
## 1 Leslie F     266474
## 2 Leslie M     112689
## 3 Robin  F     289395
## 4 Robin  M      44616
## 5 Sue    F     144465
## 6 Sue    M        519
```
]

.pull-right[


```r
names &lt;- c("Sue", "Robin", "Leslie")
babynames %&gt;% 
  filter(name %in% names) %&gt;%
  group_by(name, sex) %&gt;%
  summarise(total = sum(n)) %&gt;%
  pivot_wider(names_from = "sex", 
              values_from = "total")
```

```
## # A tibble: 3 × 3
##   name        F      M
##   &lt;chr&gt;   &lt;int&gt;  &lt;int&gt;
## 1 Leslie 266474 112689
## 2 Robin  289395  44616
## 3 Sue    144465    519
```
]

&lt;br&gt;
We see that the use of **pivot_wider()** yield a representation of the data that is more conducive to our goal of determining names that are most gender-neutral.
---
class: clear
We can now determine the most gender-neutral names for the whole babynames dataset.

```r
babynames_wide &lt;- babynames %&gt;%
  group_by(sex, name) %&gt;%
  summarise(total = sum(n)) %&gt;%
  ## set missing values in wide table to 0
  pivot_wider(names_from = "sex", values_from = "total", values_fill = 0)
babynames_wide %&gt;% filter(M &gt; 50000, F &gt; 50000) %&gt;%
  mutate(ratio = pmin(F/M, M/F)) %&gt;% ## parallel min
  arrange(desc(ratio)) %&gt;%
  head(6)
```

```
## # A tibble: 6 × 4
##   name        F      M ratio
##   &lt;chr&gt;   &lt;int&gt;  &lt;int&gt; &lt;dbl&gt;
## 1 Riley  100881  92789 0.920
## 2 Jackie  90604  78405 0.865
## 3 Casey   76020 110165 0.690
## 4 Jessie 167010 110027 0.659
## 5 Avery  117789  53519 0.454
## 6 Leslie 266474 112689 0.423
```
---
# Mutating join()
We recall the following tables

.pull-left[
&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
&lt;caption style="font-size: initial !important;"&gt;table1&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; year &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; cases &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; population &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 745 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.00e+07 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2666 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.06e+07 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 37737 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.72e+08 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 80488 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.75e+08 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 212258 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.27e+09 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 213766 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.28e+09 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]

.pull-right[
&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; 1999 &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; 2000 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 745 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2666 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 37737 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 80488 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 212258 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 213766 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;br&gt;
&lt;br&gt;
&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
&lt;caption style="font-size: initial !important;"&gt;table4b&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; 1999 &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; 2000 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.00e+07 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.06e+07 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.72e+08 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.75e+08 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.27e+09 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.28e+09 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]
---
class: clear
To go from table `\(4a\)` and `\(4b\)` to Table `\(1\)`, we need to reshape them into long tables and then combine columns. More specifically
.pull-left[

```r
table4a.long &lt;- table4a %&gt;% 
  pivot_longer(
    cols = c("1999","2000"),
    names_to = "year", 
    values_to = "cases") %&gt;% 
  arrange(year)
```
&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; year &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; cases &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 745 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 37737 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 212258 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2666 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 80488 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 213766 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]
.pull-right[

```r
table4b.long &lt;- table4b %&gt;% 
  pivot_longer(
    cols = c("1999","2000"),
    names_to = "year", 
    values_to = "cases") %&gt;% 
  arrange(year)
```
&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; year &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; cases &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.00e+07 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.72e+08 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.27e+09 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.06e+07 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.75e+08 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.28e+09 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]
---
class: clear
We then **join** the columns of the **reshaped** table `\(4b\)` to that of the **reshaped** table `\(4a\)`. The join operation we are doing is termed a [mutating join](https://dplyr.tidyverse.org/reference/mutate-joins.html).

```r
table4a.long %&gt;% left_join(table4b.long)
```

```
## Joining with `by = join_by(country, year, cases)`
```

&lt;table class="table table-striped" style="font-size: 14px; margin-left: auto; margin-right: auto;"&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; country &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; year &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; cases &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 745 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 37737 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1999 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 212258 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Afghanistan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2666 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brazil &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 80488 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; China &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 213766 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
class: clear
The help page for [mutating join](https://dplyr.tidyverse.org/reference/mutate-joins.html) operations include
+ `\(\mathrm{left\_join}(x,y, \mathrm{by} = \mathrm{NULL}, ...)\)`: return all rows from `\(x\)`, and all columns from `\(x\)` and `\(y\)`. Rows in `\(x\)` with no match in `\(y\)` will have `\(\mathrm{NA}\)` values in the new columns. If there are multiple matches between `\(x\)` and `\(y\)` then all combination of the matches are returned.
+ `\(\mathrm{right\_join}(x,y,\mathrm{by} = \mathrm{NULL}, ...)\)`: return all rows from `\(y\)`, and all columns from `\(x\)` and `\(y\)`. Rows in `\(y\)` with no match in `\(x\)` will have `\(\mathrm{NA}\)` values in the new columns...
+ `\(\mathrm{inner\_join}(x,y,\mathrm{by} = \mathrm{NULL}, ...)\)`: return all rows from `\(x\)` where there are matching values in `\(y\)`, and all columns from `\(x\)` and `\(y\)`...
+ `\(\mathrm{full\_join}(x,y,\mathrm{by} = \mathrm{NULL}, ...)\)`: return all rows and all columns from both x and y. Where there are not matching values, returns `\(\mathrm{NA}\)` for the one missing.

&lt;img src="https://d33wubrfki0l68.cloudfront.net/aeab386461820b029b7e7606ccff1286f623bae1/ef0d4/diagrams/join-venn.png" width="80%" style="display: block; margin: auto;" /&gt;
---
#Visualizing joins
.pull-left[
&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/108c0749d084c03103f8e1e8276c20e06357b124/5f113/diagrams/join-setup.png" alt="Join setup; figure from Section 13.4 of R4DS" width="50%" /&gt;
&lt;p class="caption"&gt;Join setup; figure from Section 13.4 of R4DS&lt;/p&gt;
&lt;/div&gt;
]
.pull-right[
&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/3abea0b730526c3f053a3838953c35a0ccbe8980/7f29b/diagrams/join-inner.png" alt="Inner join" width="120%" /&gt;
&lt;p class="caption"&gt;Inner join&lt;/p&gt;
&lt;/div&gt;
]
---
class: clear
&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/9c12ca9e12ed26a7c5d2aa08e36d2ac4fb593f1e/79980/diagrams/join-outer.png" alt="Outer joins" width="50%" /&gt;
&lt;p class="caption"&gt;Outer joins&lt;/p&gt;
&lt;/div&gt;
---
class: clear
&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/6faac3e996263827cb57fc5803df6192541a9a4b/c7d74/diagrams/join-one-to-many.png" alt="Duplicate keys (one to many)" width="50%" /&gt;
&lt;p class="caption"&gt;Duplicate keys (one to many)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/d37530bbf7749f48c02684013ae72b2996b07e25/37510/diagrams/join-many-to-many.png" alt="Duplicate keys (many to many)" width="50%" /&gt;
&lt;p class="caption"&gt;Duplicate keys (many to many)&lt;/p&gt;
&lt;/div&gt;

---
#Combining multiple tables
The **join()** operations are particularly important for combining multiple tables. For illustrastion we look at the following tables from the **nycflights13** library.

+ **flights**: contains information about flights departing NYC airports during `\(2013\)`.
+ **airlines**: maps abbreviated code to full carrier name.
+ **airports**: gives information about each airport as identified by its FAA code.
+ **planes**: gives information about each plane as identified by its *tailnum*
+ **weather**: provides weather information at each NYC airport for each hour.


```r
flights
```

```
## # A tibble: 336,776 × 19
##    year month   day dep_time sched_dep_time dep_delay arr_time
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
## 1  2013     1     1      517            515         2      830
## 2  2013     1     1      533            529         4      850
## 3  2013     1     1      542            540         2      923
## # ℹ 336,773 more rows
## # ℹ 12 more variables: sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;,
## #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
## #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
## #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;
```
---
class: clear

```r
airlines
```

```
## # A tibble: 16 × 2
##   carrier name                  
##   &lt;chr&gt;   &lt;chr&gt;                 
## 1 9E      Endeavor Air Inc.     
## 2 AA      American Airlines Inc.
## 3 AS      Alaska Airlines Inc.  
## # ℹ 13 more rows
```

```r
airports
```

```
## # A tibble: 1,458 × 8
##   faa   name                         lat   lon   alt    tz dst   tzone
##   &lt;chr&gt; &lt;chr&gt;                      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;
## 1 04G   Lansdowne Airport           41.1 -80.6  1044    -5 A     Amer…
## 2 06A   Moton Field Municipal Air…  32.5 -85.7   264    -6 A     Amer…
## 3 06C   Schaumburg Regional         42.0 -88.1   801    -6 A     Amer…
## # ℹ 1,455 more rows
```
---
class: clear

```r
planes
```

```
## # A tibble: 3,322 × 9
##   tailnum  year type     manufacturer model engines seats speed engine
##   &lt;chr&gt;   &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;        &lt;chr&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1 N10156   2004 Fixed w… EMBRAER      EMB-…       2    55    NA Turbo…
## 2 N102UW   1998 Fixed w… AIRBUS INDU… A320…       2   182    NA Turbo…
## 3 N103US   1999 Fixed w… AIRBUS INDU… A320…       2   182    NA Turbo…
## # ℹ 3,319 more rows
```

```r
weather
```

```
## # A tibble: 26,115 × 15
##   origin  year month   day  hour  temp  dewp humid wind_dir wind_speed
##   &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
## 1 EWR     2013     1     1     1  39.0  26.1  59.4      270      10.4 
## 2 EWR     2013     1     1     2  39.0  27.0  61.6      250       8.06
## 3 EWR     2013     1     1     3  39.0  28.0  64.4      240      11.5 
## # ℹ 26,112 more rows
## # ℹ 5 more variables: wind_gust &lt;dbl&gt;, precip &lt;dbl&gt;, pressure &lt;dbl&gt;,
## #   visib &lt;dbl&gt;, time_hour &lt;dttm&gt;
```
---
class: clear
Suppose we now want to get the full airlines name for each flights (as opposed to the carrier code). For ease of presentation, we will only include a subset of the original columns for the **flights** data frame.

```r
flights.sml &lt;- select(flights, year:day, dep_time, tailnum, carrier, dest)
flights.sml
```

```
## # A tibble: 336,776 × 7
##    year month   day dep_time tailnum carrier dest 
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;
## 1  2013     1     1      517 N14228  UA      IAH  
## 2  2013     1     1      533 N24211  UA      IAH  
## 3  2013     1     1      542 N619AA  AA      MIA  
## # ℹ 336,773 more rows
```

```r
flights.sml %&gt;% inner_join(airlines)
```

```
## Joining with `by = join_by(carrier)`
```

```
## # A tibble: 336,776 × 8
##    year month   day dep_time tailnum carrier dest  name               
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;              
## 1  2013     1     1      517 N14228  UA      IAH   United Air Lines I…
## 2  2013     1     1      533 N24211  UA      IAH   United Air Lines I…
## 3  2013     1     1      542 N619AA  AA      MIA   American Airlines …
## # ℹ 336,773 more rows
```
---
class: clear
Suppose that we want to get detailed information about the airplanes used in the flights.
In this case, we want to match the observations in both table using the *tailnum* column.

```r
flights.sml %&gt;% inner_join(planes)
```

```
## Joining with `by = join_by(year, tailnum)`
```

```
## # A tibble: 4,630 × 14
##    year month   day dep_time tailnum carrier dest  type   manufacturer
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;       
## 1  2013     1    18     1846 N37465  UA      FLL   Fixed… BOEING      
## 2  2013    10     1      647 N355JB  B6      BOS   Fixed… EMBRAER     
## 3  2013    10     1      652 N37471  UA      LAX   Fixed… BOEING      
## # ℹ 4,627 more rows
## # ℹ 5 more variables: model &lt;chr&gt;, engines &lt;int&gt;, seats &lt;int&gt;,
## #   speed &lt;int&gt;, engine &lt;chr&gt;
```

```r
flights.sml %&gt;% inner_join(planes, by = "tailnum")
```

```
## # A tibble: 284,170 × 15
##   year.x month   day dep_time tailnum carrier dest  year.y type       
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  &lt;int&gt; &lt;chr&gt;      
## 1   2013     1     1      517 N14228  UA      IAH     1999 Fixed wing…
## 2   2013     1     1      533 N24211  UA      IAH     1998 Fixed wing…
## 3   2013     1     1      542 N619AA  AA      MIA     1990 Fixed wing…
## # ℹ 284,167 more rows
## # ℹ 6 more variables: manufacturer &lt;chr&gt;, model &lt;chr&gt;, engines &lt;int&gt;,
## #   seats &lt;int&gt;, speed &lt;int&gt;, engine &lt;chr&gt;
```
---
class: clear
Comparing the following two variants of **join()**, we see that there are values in the *tailnum* column of the **flights** table
that do not appear in the **planes** table. 

We thus need to be careful when using **inner_join()** as it can silently remove observations.


```r
flights.sml %&gt;% left_join(planes, by = "tailnum")
```

```
## # A tibble: 336,776 × 15
##   year.x month   day dep_time tailnum carrier dest  year.y type       
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  &lt;int&gt; &lt;chr&gt;      
## 1   2013     1     1      517 N14228  UA      IAH     1999 Fixed wing…
## 2   2013     1     1      533 N24211  UA      IAH     1998 Fixed wing…
## 3   2013     1     1      542 N619AA  AA      MIA     1990 Fixed wing…
## # ℹ 336,773 more rows
## # ℹ 6 more variables: manufacturer &lt;chr&gt;, model &lt;chr&gt;, engines &lt;int&gt;,
## #   seats &lt;int&gt;, speed &lt;int&gt;, engine &lt;chr&gt;
```

```r
flights.sml %&gt;% inner_join(planes, by = "tailnum")
```

```
## # A tibble: 284,170 × 15
##   year.x month   day dep_time tailnum carrier dest  year.y type       
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  &lt;int&gt; &lt;chr&gt;      
## 1   2013     1     1      517 N14228  UA      IAH     1999 Fixed wing…
## 2   2013     1     1      533 N24211  UA      IAH     1998 Fixed wing…
## 3   2013     1     1      542 N619AA  AA      MIA     1990 Fixed wing…
## # ℹ 284,167 more rows
## # ℹ 6 more variables: manufacturer &lt;chr&gt;, model &lt;chr&gt;, engines &lt;int&gt;,
## #   seats &lt;int&gt;, speed &lt;int&gt;, engine &lt;chr&gt;
```
---
class: clear
When the identifying key of one table is different from the other table, we use `by = c("a" = "b")`, e.g.,

```r
airports
```

```
## # A tibble: 1,458 × 8
##   faa   name                         lat   lon   alt    tz dst   tzone
##   &lt;chr&gt; &lt;chr&gt;                      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;
## 1 04G   Lansdowne Airport           41.1 -80.6  1044    -5 A     Amer…
## 2 06A   Moton Field Municipal Air…  32.5 -85.7   264    -6 A     Amer…
## 3 06C   Schaumburg Regional         42.0 -88.1   801    -6 A     Amer…
## # ℹ 1,455 more rows
```

```r
flights.sml %&gt;% left_join(airports, by = c("dest" = "faa"))
```

```
## # A tibble: 336,776 × 14
##    year month   day dep_time tailnum carrier dest  name      lat   lon
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;
## 1  2013     1     1      517 N14228  UA      IAH   George…  30.0 -95.3
## 2  2013     1     1      533 N24211  UA      IAH   George…  30.0 -95.3
## 3  2013     1     1      542 N619AA  AA      MIA   Miami …  25.8 -80.3
## # ℹ 336,773 more rows
## # ℹ 4 more variables: alt &lt;dbl&gt;, tz &lt;dbl&gt;, dst &lt;chr&gt;, tzone &lt;chr&gt;
```
---
#Filtering joins
These operations match observations in the same way as `left_join(x,y)`, but instead of adding new columns to `\(x\)`, they only filter the observations in `\(x\)`. More specifically

+ `semi_join(x,y)` keeps all observations in `\(x\)` that have a match in `\(y\)`.
+ `anti_join(x,y)` keeps all observations in `\(x\)` that **do not** have a match in `\(y\)`.

For example, suppose we are interested in all flights that go to the top ten most popular destinations. We first find these destinations and then filter flights to these destinations.


```r
top_dest &lt;- flights %&gt;% group_by(dest) %&gt;% summarise(count = n()) %&gt;% 
  arrange(desc(count)) %&gt;% head(10)
```
---
class: clear
.pull-left[

```r
flights %&gt;% 
  filter(dest %in% top_dest$dest) %&gt;%
  select(year:day, dest)
```

```
## # A tibble: 141,145 × 4
##    year month   day dest 
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;
## 1  2013     1     1 MIA  
## 2  2013     1     1 ATL  
## 3  2013     1     1 ORD  
## # ℹ 141,142 more rows
```
]
.pull-right[

```r
flights %&gt;% semi_join(top_dest) %&gt;%
  select(year:day, dest)
```

```
## # A tibble: 141,145 × 4
##    year month   day dest 
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;
## 1  2013     1     1 MIA  
## 2  2013     1     1 ATL  
## 3  2013     1     1 ORD  
## # ℹ 141,142 more rows
```
]
---
class: clear
As another example of filtering joins, we noted that not all the tailnum associated with planes used in the **flights** table appeared in the **planes** table. 

We might want to count how many flights are associated with each of these tailnum.

```r
flights %&gt;% anti_join(planes, by = "tailnum") %&gt;%
  group_by(tailnum) %&gt;% summarise(n = n()) %&gt;% arrange(desc(n))
```

```
## # A tibble: 722 × 2
##   tailnum     n
##   &lt;chr&gt;   &lt;int&gt;
## 1 &lt;NA&gt;     2512
## 2 N725MQ    575
## 3 N722MQ    513
## # ℹ 719 more rows
```
---
# Example 3: US Healthcare
We now present a more involved example of tidying data with **tidyr** and joining tables and wrangling data with **dplyr** verbs. 

The example uses health care data from the **Kaiser Family Foundation** and we follow the analysis of [S. Hicks and R. Peng](https://jhu-advdatasci.github.io/2018/lectures/03-tidyverse-1.html).

The data is included in three csv files
+ one file records state-level health insurance coverage from `\(2013\)` to `\(2016\)`
+ another file records state-level health care expenditures from `\(1991\)` to `\(2014\)`
+ the third file records state-level life expectancy at birth.

We take a look at the first few lines of the health insurance coverage csv file. 

```r
library(readr)
read_lines(file = "https://bit.ly/2YLGiyx", n_max = 5)
```

```
## [1] "\"Title: Health Insurance Coverage of the Total Population | The Henry J. Kaiser Family Foundation\""                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
## [2] "\"Timeframe: 2013 - 2016\""                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
## [3] "\"Location\",\"2013__Employer\",\"2013__Non-Group\",\"2013__Medicaid\",\"2013__Medicare\",\"2013__Other Public\",\"2013__Uninsured\",\"2013__Total\",\"2014__Employer\",\"2014__Non-Group\",\"2014__Medicaid\",\"2014__Medicare\",\"2014__Other Public\",\"2014__Uninsured\",\"2014__Total\",\"2015__Employer\",\"2015__Non-Group\",\"2015__Medicaid\",\"2015__Medicare\",\"2015__Other Public\",\"2015__Uninsured\",\"2015__Total\",\"2016__Employer\",\"2016__Non-Group\",\"2016__Medicaid\",\"2016__Medicare\",\"2016__Other Public\",\"2016__Uninsured\",\"2016__Total\""
## [4] "\"United States\",\"155696900\",\"13816000\",\"54919100\",\"40876300\",\"6295400\",\"41795100\",\"313401200\",\"154347500\",\"19313000\",\"61650400\",\"41896500\",\"5985000\",\"32967500\",\"316159900\",\"155965800\",\"21816500\",\"62384500\",\"43308400\",\"6422300\",\"28965900\",\"318868500\",\"157381500\",\"21884400\",\"62303400\",\"44550200\",\"6192200\",\"28051900\",\"320372000\""                                                                                                                                                                           
## [5] "\"Alabama\",\"2126500\",\"174200\",\"869700\",\"783000\",\"85600\",\"724800\",\"4763900\",\"2202800\",\"288900\",\"891900\",\"718400\",\"143900\",\"522200\",\"4768000\",\"2218000\",\"291500\",\"911400\",\"719100\",\"174600\",\"519400\",\"4833900\",\"2263800\",\"262400\",\"997000\",\"761200\",\"128800\",\"420800\",\"4834100\""
```
---
class: clear
Ignore the first two lines. The third line contains column names. Hence

```r
## read_csv is part of the readr library.
coverage &lt;- read_csv(file = "https://bit.ly/2YLGiyx", 
                     skip = 2, col_names = TRUE)
```

```
## Warning: One or more parsing issues, call `problems()` on your data frame for details,
## e.g.:
##   dat &lt;- vroom(...)
##   problems(dat)
```

```r
coverage[53:nrow(coverage),]
```

```
## # A tibble: 26 × 29
##   Location         `2013__Employer` `2013__Non-Group` `2013__Medicaid`
##   &lt;chr&gt;                       &lt;dbl&gt;             &lt;dbl&gt;            &lt;dbl&gt;
## 1 Notes                          NA                NA               NA
## 2 The majority of…               NA                NA               NA
## 3 &lt;NA&gt;                           NA                NA               NA
## # ℹ 23 more rows
## # ℹ 25 more variables: `2013__Medicare` &lt;dbl&gt;,
## #   `2013__Other Public` &lt;chr&gt;, `2013__Uninsured` &lt;dbl&gt;,
## #   `2013__Total` &lt;dbl&gt;, `2014__Employer` &lt;dbl&gt;,
## #   `2014__Non-Group` &lt;dbl&gt;, `2014__Medicaid` &lt;dbl&gt;,
## #   `2014__Medicare` &lt;dbl&gt;, `2014__Other Public` &lt;chr&gt;,
## #   `2014__Uninsured` &lt;dbl&gt;, `2014__Total` &lt;dbl&gt;, …
```
---
class: clear
The first `\(52\)` lines appear fine. The `\(53\)`-rd line onwards appear to be notes/annotations and should be ignore.

```r
coverage &lt;- coverage[1:(which(coverage$Location == "Notes") - 1),]
## Equivalently
## coverage %&gt;% filter(cumall(Location != "Notes"))
```
The structure of the remaining two files recording health spending and life expectancy are similar. Hence

```r
spending &lt;- read_csv(file = "https://bit.ly/33j3fZm", 
                     skip = 2,  col_names = TRUE)
spending &lt;- spending %&gt;% filter(cumall(Location != "Notes"))
life_exp &lt;- read_csv(file = "https://bit.ly/2MK13Es", 
                     skip = 2, col_names = TRUE)
life_exp &lt;- life_exp %&gt;% filter(cumall(Location != "Sources"))
```
---
class: clear
We now take a *glimpse* at the coverage data. 

```r
glimpse(coverage)
```

```
## Rows: 52
## Columns: 29
## $ Location             &lt;chr&gt; "United States", "Alabama", "Alaska", "…
## $ `2013__Employer`     &lt;dbl&gt; 1.56e+08, 2.13e+06, 3.65e+05, 2.88e+06,…
## $ `2013__Non-Group`    &lt;dbl&gt; 13816000, 174200, 24000, 170800, 155600…
## $ `2013__Medicaid`     &lt;dbl&gt; 54919100, 869700, 95000, 1346100, 60080…
## $ `2013__Medicare`     &lt;dbl&gt; 40876300, 783000, 55200, 842000, 515200…
## $ `2013__Other Public` &lt;chr&gt; "6295400", "85600", "60600", "N/A", "67…
## $ `2013__Uninsured`    &lt;dbl&gt; 41795100, 724800, 102200, 1223000, 4368…
## $ `2013__Total`        &lt;dbl&gt; 3.13e+08, 4.76e+06, 7.02e+05, 6.60e+06,…
## $ `2014__Employer`     &lt;dbl&gt; 1.54e+08, 2.20e+06, 3.45e+05, 2.84e+06,…
## $ `2014__Non-Group`    &lt;dbl&gt; 19313000, 288900, 26800, 333500, 231700…
## $ `2014__Medicaid`     &lt;dbl&gt; 61650400, 891900, 130100, 1639400, 6392…
## $ `2014__Medicare`     &lt;dbl&gt; 41896500, 718400, 55300, 911100, 479400…
## $ `2014__Other Public` &lt;chr&gt; "5985000", "143900", "37300", "N/A", "8…
## $ `2014__Uninsured`    &lt;dbl&gt; 32967500, 522200, 100800, 827100, 28720…
## $ `2014__Total`        &lt;dbl&gt; 3.16e+08, 4.77e+06, 6.96e+05, 6.66e+06,…
## $ `2015__Employer`     &lt;dbl&gt; 1.56e+08, 2.22e+06, 3.56e+05, 2.77e+06,…
## $ `2015__Non-Group`    &lt;dbl&gt; 21816500, 291500, 22300, 278400, 200200…
## $ `2015__Medicaid`     &lt;dbl&gt; 62384500, 911400, 128100, 1711500, 6414…
## $ `2015__Medicare`     &lt;dbl&gt; 43308400, 719100, 60900, 949000, 484500…
## $ `2015__Other Public` &lt;chr&gt; "6422300", "174600", "47700", "189300",…
## $ `2015__Uninsured`    &lt;dbl&gt; 28965900, 519400, 90500, 844800, 268400…
## $ `2015__Total`        &lt;dbl&gt; 3.19e+08, 4.83e+06, 7.05e+05, 6.74e+06,…
## $ `2016__Employer`     &lt;dbl&gt; 1.57e+08, 2.26e+06, 3.24e+05, 3.01e+06,…
## $ `2016__Non-Group`    &lt;dbl&gt; 21884400, 262400, 20300, 377000, 252900…
## $ `2016__Medicaid`     &lt;dbl&gt; 62303400, 997000, 145400, 1468400, 6186…
## $ `2016__Medicare`     &lt;dbl&gt; 44550200, 761200, 68200, 1028000, 49000…
## $ `2016__Other Public` &lt;chr&gt; "6192200", "128800", "55600", "172500",…
## $ `2016__Uninsured`    &lt;dbl&gt; 28051900, 420800, 96900, 833700, 225500…
## $ `2016__Total`        &lt;dbl&gt; 3.20e+08, 4.83e+06, 7.11e+05, 6.89e+06,…
```
---
class: clear
The data is **untidy** and needs a bit of pivoting

```r
coverage_long &lt;- coverage %&gt;%  
  pivot_longer(cols = -c("Location"), 
               names_to  = "year_type", values_to = "tot_coverage")
```

```
## Error in `pivot_longer()`:
## ! Can't combine `2013__Employer` &lt;double&gt; and `2013__Other Public` &lt;character&gt;.
```
Hmm, this is annoying. It turns out that the variables like `2013__Other Public` contains missing values which are coded as "N/A" and not `NA`. 

---
class: clear

Luckily enough, tis is but a scratch.

```r
coverage &lt;- coverage %&gt;% mutate(across(contains("Public"),as.numeric))
glimpse(coverage)
```

```
## Rows: 52
## Columns: 29
## $ Location             &lt;chr&gt; "United States", "Alabama", "Alaska", "…
## $ `2013__Employer`     &lt;dbl&gt; 1.56e+08, 2.13e+06, 3.65e+05, 2.88e+06,…
## $ `2013__Non-Group`    &lt;dbl&gt; 13816000, 174200, 24000, 170800, 155600…
## $ `2013__Medicaid`     &lt;dbl&gt; 54919100, 869700, 95000, 1346100, 60080…
## $ `2013__Medicare`     &lt;dbl&gt; 40876300, 783000, 55200, 842000, 515200…
## $ `2013__Other Public` &lt;dbl&gt; 6295400, 85600, 60600, NA, 67600, 67540…
## $ `2013__Uninsured`    &lt;dbl&gt; 41795100, 724800, 102200, 1223000, 4368…
## $ `2013__Total`        &lt;dbl&gt; 3.13e+08, 4.76e+06, 7.02e+05, 6.60e+06,…
## $ `2014__Employer`     &lt;dbl&gt; 1.54e+08, 2.20e+06, 3.45e+05, 2.84e+06,…
## $ `2014__Non-Group`    &lt;dbl&gt; 19313000, 288900, 26800, 333500, 231700…
## $ `2014__Medicaid`     &lt;dbl&gt; 61650400, 891900, 130100, 1639400, 6392…
## $ `2014__Medicare`     &lt;dbl&gt; 41896500, 718400, 55300, 911100, 479400…
## $ `2014__Other Public` &lt;dbl&gt; 5985000, 143900, 37300, NA, 82000, 6344…
## $ `2014__Uninsured`    &lt;dbl&gt; 32967500, 522200, 100800, 827100, 28720…
## $ `2014__Total`        &lt;dbl&gt; 3.16e+08, 4.77e+06, 6.96e+05, 6.66e+06,…
## $ `2015__Employer`     &lt;dbl&gt; 1.56e+08, 2.22e+06, 3.56e+05, 2.77e+06,…
## $ `2015__Non-Group`    &lt;dbl&gt; 21816500, 291500, 22300, 278400, 200200…
## $ `2015__Medicaid`     &lt;dbl&gt; 62384500, 911400, 128100, 1711500, 6414…
## $ `2015__Medicare`     &lt;dbl&gt; 43308400, 719100, 60900, 949000, 484500…
## $ `2015__Other Public` &lt;dbl&gt; 6422300, 174600, 47700, 189300, 63700, …
## $ `2015__Uninsured`    &lt;dbl&gt; 28965900, 519400, 90500, 844800, 268400…
## $ `2015__Total`        &lt;dbl&gt; 3.19e+08, 4.83e+06, 7.05e+05, 6.74e+06,…
## $ `2016__Employer`     &lt;dbl&gt; 1.57e+08, 2.26e+06, 3.24e+05, 3.01e+06,…
## $ `2016__Non-Group`    &lt;dbl&gt; 21884400, 262400, 20300, 377000, 252900…
## $ `2016__Medicaid`     &lt;dbl&gt; 62303400, 997000, 145400, 1468400, 6186…
## $ `2016__Medicare`     &lt;dbl&gt; 44550200, 761200, 68200, 1028000, 49000…
## $ `2016__Other Public` &lt;dbl&gt; 6192200, 128800, 55600, 172500, 67500, …
## $ `2016__Uninsured`    &lt;dbl&gt; 28051900, 420800, 96900, 833700, 225500…
## $ `2016__Total`        &lt;dbl&gt; 3.20e+08, 4.83e+06, 7.11e+05, 6.89e+06,…
```

---
class: clear

```r
coverage_long &lt;- coverage %&gt;%  
  pivot_longer(cols = -c("Location"), 
               names_to  = "year_type", values_to = "tot_coverage")
coverage_long
```

```
## # A tibble: 1,456 × 3
##   Location      year_type       tot_coverage
##   &lt;chr&gt;         &lt;chr&gt;                  &lt;dbl&gt;
## 1 United States 2013__Employer     155696900
## 2 United States 2013__Non-Group     13816000
## 3 United States 2013__Medicaid      54919100
## # ℹ 1,453 more rows
```

The spending data is also untidy. More pivoting

```r
spending_long &lt;- spending %&gt;% 
  pivot_longer(cols = -c("Location"), 
               names_to = "year", values_to = "tot_spending")
spending_long
```

```
## # A tibble: 1,248 × 3
##   Location      year                        tot_spending
##   &lt;chr&gt;         &lt;chr&gt;                              &lt;dbl&gt;
## 1 United States 1991__Total Health Spending       675896
## 2 United States 1992__Total Health Spending       731455
## 3 United States 1993__Total Health Spending       778684
## # ℹ 1,245 more rows
```
---
class: clear
We now separate the `year` column for the **spending** data and the `year_type` column for the **coverage** data

```r
spending_long &lt;- spending_long %&gt;% 
  separate(year, sep = "__", into = c("year", "name"), convert = TRUE) %&gt;%
  select(-name)
spending_long
```

```
## # A tibble: 1,248 × 3
##   Location       year tot_spending
##   &lt;chr&gt;         &lt;int&gt;        &lt;dbl&gt;
## 1 United States  1991       675896
## 2 United States  1992       731455
## 3 United States  1993       778684
## # ℹ 1,245 more rows
```

```r
coverage_long &lt;- coverage_long %&gt;%
  separate(year_type, sep = "__", into = c("year", "type"), convert = TRUE)
coverage_long
```

```
## # A tibble: 1,456 × 4
##   Location       year type      tot_coverage
##   &lt;chr&gt;         &lt;int&gt; &lt;chr&gt;            &lt;dbl&gt;
## 1 United States  2013 Employer     155696900
## 2 United States  2013 Non-Group     13816000
## 3 United States  2013 Medicaid      54919100
## # ℹ 1,453 more rows
```
---
class: clear
We also clean up the column names of the **life_exp** data frame.

```r
life_exp &lt;- life_exp %&gt;% 
  rename(life_exp_years = `Life Expectancy at Birth (years)`)
```

We now add more contextual information to the **coverage** dataframe, such as the state region and abbreviation. 
These information are available from the **state** dataframe in the [datasets](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/datasets-package.html) library. 
We note that the **coverage** data frame includes records for Washington DC, which is missing from the state dataset. 

```r
library(datasets)
data(state)
states.df &lt;- tibble(
  state.name = c(state.name, "District of Columbia"),
  state.abb =  c(state.abb, "DC"),
  state.region = as.factor(c(as.character(state.region), "South")))
coverage_long &lt;- coverage_long %&gt;% 
  left_join(states.df, by = c("Location" = "state.name"))
coverage_long
```

```
## # A tibble: 1,456 × 6
##   Location       year type      tot_coverage state.abb state.region
##   &lt;chr&gt;         &lt;int&gt; &lt;chr&gt;            &lt;dbl&gt; &lt;chr&gt;     &lt;fct&gt;       
## 1 United States  2013 Employer     155696900 &lt;NA&gt;      &lt;NA&gt;        
## 2 United States  2013 Non-Group     13816000 &lt;NA&gt;      &lt;NA&gt;        
## 3 United States  2013 Medicaid      54919100 &lt;NA&gt;      &lt;NA&gt;        
## # ℹ 1,453 more rows
```
---
class: clear

We now merge the **coverage**, **spending** and **life_exp** data frames together. The **coverage** data frame records span `\(2013\)` to `\(2016\)` while the **spending** data frame records span `\(1991\)` to `\(2014\)`. In this case we wants to include only the years `\(2013\)` and `\(2014\)` in the merged datasets.

```r
hc &lt;- coverage_long %&gt;% 
  inner_join(spending_long) %&gt;%
  inner_join(life_exp)
```

```
## Joining with `by = join_by(Location, year)`
## Joining with `by = join_by(Location)`
```

```r
hc
```

```
## # A tibble: 728 × 8
##   Location       year type      tot_coverage state.abb state.region
##   &lt;chr&gt;         &lt;int&gt; &lt;chr&gt;            &lt;dbl&gt; &lt;chr&gt;     &lt;fct&gt;       
## 1 United States  2013 Employer     155696900 &lt;NA&gt;      &lt;NA&gt;        
## 2 United States  2013 Non-Group     13816000 &lt;NA&gt;      &lt;NA&gt;        
## 3 United States  2013 Medicaid      54919100 &lt;NA&gt;      &lt;NA&gt;        
## # ℹ 725 more rows
## # ℹ 2 more variables: tot_spending &lt;dbl&gt;, life_exp_years &lt;dbl&gt;
```
---
class: clear
Our data is now in a reasonable format for visualization and further analysis. One problem remains in that "Total" is not a valid type of healthcare coverage. Rather, a row for which `type = "Total"` 
is a record of the total number of people in that state. We remedy this issue via

```r
pop &lt;- hc %&gt;% 
  filter(type == "Total") %&gt;%
  select(Location, year, tot_coverage) %&gt;%
  rename(tot_population = tot_coverage)
hc &lt;- hc %&gt;%
  filter(Location != "United States", type != "Total") %&gt;%
  left_join(pop) %&gt;% select(Location, year, type, tot_population, everything())
hc
```

```
## # A tibble: 612 × 9
##   Location  year type      tot_population tot_coverage state.abb
##   &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;              &lt;dbl&gt;        &lt;dbl&gt; &lt;chr&gt;    
## 1 Alabama   2013 Employer         4763900      2126500 AL       
## 2 Alabama   2013 Non-Group        4763900       174200 AL       
## 3 Alabama   2013 Medicaid         4763900       869700 AL       
## # ℹ 609 more rows
## # ℹ 3 more variables: state.region &lt;fct&gt;, tot_spending &lt;dbl&gt;,
## #   life_exp_years &lt;dbl&gt;
```
---
class: clear
Let us now try to answer the following question of "Is there a relationship between healthcare coverage and healthcare spending in the US ?" We take a look at Employer type coverage for `\(2013\)`. A naive visualization indicates a strong relationship, but there is confounding effect due to population size.

&lt;img src="intro_tidy_files/figure-html/unnamed-chunk-75-1.png" width="120%" style="display: block; margin: auto;" /&gt;
---
class: clear
If we remove the effect of population, the relationship between spending and coverage becomes much weaker. 

```r
hc &lt;- hc %&gt;%
  mutate(spending_capita = (tot_spending*10^6)/tot_population,
         prop_coverage = tot_coverage/tot_population)
hc %&gt;% filter(type == "Employer", year == "2013") %&gt;%
  ggplot(aes(x = spending_capita, y = prop_coverage)) +
  geom_point() + xlab("spending per capita") + 
  ylab("proportion of Employer coverage") + geom_smooth(method = "lm")
```

&lt;img src="intro_tidy_files/figure-html/unnamed-chunk-76-1.png" width="70%" style="display: block; margin: auto;" /&gt;
---
# Automation and iteration
Compare the following code chunks.
.pull-left[

```r
df &lt;- tibble(
  a = rnorm(100),
  b = rnorm(100),
  c = rnorm(100),
  d = rnorm(100)
)
output &lt;- numeric(length(df))
for(i in seq_along(df)){
  output[i] &lt;- median(df[[i]])
}
output
```

```
## [1]  0.2961  0.1521 -0.0841 -0.1102
```

```r
apply(df,2,median)
```

```
##       a       b       c       d 
##  0.2961  0.1521 -0.0841 -0.1102
```
]

.pull-right[

```r
lapply(df,median)
```

```
## $a
## [1] 0.296
## 
## $b
## [1] 0.152
## 
## $c
## [1] -0.0841
## 
## $d
## [1] -0.11
```

```r
sapply(df,median)
```

```
##       a       b       c       d 
##  0.2961  0.1521 -0.0841 -0.1102
```
]
---
class: clear
The **apply** family of operations allow for complex iteration over elements of a data frame, list, or matrix, without the need to write explicit loops construct. As another example, compare

.pull-left[

```r
probs = c(0.25,0.5,0.75)
output2 &lt;- matrix(0, length(probs), 
                     length(df))
for(i in seq_along(df)){
  output2[,i] &lt;- quantile(df[[i]], 
                          probs)
}
output2
```

```
##        [,1]   [,2]    [,3]   [,4]
## [1,] -0.544 -0.670 -0.6408 -0.580
## [2,]  0.296  0.152 -0.0841 -0.110
## [3,]  0.874  1.088  0.4050  0.631
```
]

.pull-right[

```r
apply(df, 2, quantile, probs)
```

```
##          a      b       c      d
## 25% -0.544 -0.670 -0.6408 -0.580
## 50%  0.296  0.152 -0.0841 -0.110
## 75%  0.874  1.088  0.4050  0.631
```

```r
sapply(df, quantile, probs)
```

```
##          a      b       c      d
## 25% -0.544 -0.670 -0.6408 -0.580
## 50%  0.296  0.152 -0.0841 -0.110
## 75%  0.874  1.088  0.4050  0.631
```
]
---
class: clear

There are numerous variants of *apply*, including

+ `\(\mathrm{apply}(X, \mathrm{margin}, \mathrm{FUN}, ...)\)` which takes a data frame, array or matrix `\(X\)` and returns a vector/array/list of values obtained by applying `\(\mathrm{FUN}\)` to the margins (e.g., rows and columns) of `\(X\)`. 

+ `\(\mathrm{lapply}(X, \mathrm{FUN}, ...)\)` which takes a list `\(X\)` and return a list of the same length as `\(X\)`, each element of which is the result of applying `\(\mathrm{FUN}\)` to the corresponding element of `\(X\)`.

+ `\(\mathrm{sapply}(X, \mathrm{FUN}, ...)\)` is a user-friendly wrapper of `\(\mathrm{lapply}\)` that try to return a vector, matrix, or array, if possible.

+ `\(\mathrm{mapply}(\mathrm{FUN}, ..., \mathrm{MoreArgs})\)` is a multivariate version of `\(\mathrm{sapply}\)`; `\(\mathrm{mapply}\)` applies FUN to the first elements of each `\(...\)` argument, the second elements, the third elements, and so on.

+ `\(\mathrm{tapply}(X, \mathrm{INDEX}, \mathrm{FUN} = \mathrm{NULL}, ...)\)` apply `\(\mathrm{FUN}\)` to each (non-empty) group of values of `\(X\)` given by a unique combination of the levels of factors contained in the list `\(\mathrm{INDEX}\)`

---
class: clear
The following are some examples of *apply* and its variants.


```r
# ?beaver1 and ?beaver2
beaver &lt;- list(beaver1 = beaver1, beaver2 = beaver2)
lapply(beaver, function(x) apply(x,2,mean))
```

```
## $beaver1
##      day     time     temp    activ 
## 3.46e+02 1.31e+03 3.69e+01 5.26e-02 
## 
## $beaver2
##     day    time    temp   activ 
##  307.13 1446.20   37.60    0.62
```

```r
sapply(beaver, function(x) apply(x,2,mean))
```

```
##        beaver1 beaver2
## day   3.46e+02  307.13
## time  1.31e+03 1446.20
## temp  3.69e+01   37.60
## activ 5.26e-02    0.62
```

---
class: clear

```r
head(mtcars)
```

```
## # A tibble: 6 × 11
##     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4
## 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4
## 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1
## 4  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1
## 5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2
## 6  18.1     6   225   105  2.76  3.46  20.2     1     0     3     1
```

```r
tapply(mtcars$mpg, mtcars$cyl, mean) ## Work like group_by and summarise
```

```
##    4    6    8 
## 26.7 19.7 15.1
```

```r
tapply(mtcars$mpg, list(mtcars$cyl, mtcars$gear), mean)
```

```
##      3    4    5
## 4 21.5 26.9 28.2
## 6 19.8 19.8 19.7
## 8 15.1   NA 15.4
```

---
class: clear

Nesting a *tapply* within an *apply* is particularly useful.

```r
apply(mtcars, 2, function(x) tapply(x, mtcars$cyl, mean))
```

```
##    mpg cyl disp    hp drat   wt qsec    vs    am gear carb
## 4 26.7   4  105  82.6 4.07 2.29 19.1 0.909 0.727 4.09 1.55
## 6 19.7   6  183 122.3 3.59 3.12 18.0 0.571 0.429 3.86 3.43
## 8 15.1   8  353 209.2 3.23 4.00 16.8 0.000 0.143 3.29 3.50
```

We end with some examples of *mapply*

.pull-left[

```r
mapply(rep, 1:4, 4:1)
```

```
## [[1]]
## [1] 1 1 1 1
## 
## [[2]]
## [1] 2 2 2
## 
## [[3]]
## [1] 3 3
## 
## [[4]]
## [1] 4
```
]

.pull-right[

```r
mapply(rep, 4:1, 1:4)
```

```
## [[1]]
## [1] 4
## 
## [[2]]
## [1] 3 3
## 
## [[3]]
## [1] 2 2 2
## 
## [[4]]
## [1] 1 1 1 1
```
]
---
class: clear

```r
mapply(rep, 1:4, 4)
```

```
##      [,1] [,2] [,3] [,4]
## [1,]    1    2    3    4
## [2,]    1    2    3    4
## [3,]    1    2    3    4
## [4,]    1    2    3    4
```

```r
X &lt;- cbind(1:5, 6:10)
mapply(function(x,y) x*y, X[,1], X[,2])
```

```
## [1]  6 14 24 36 50
```
---
#Purrr: an alternative to apply()
The [apply](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/apply) family of operations are powerful, but its syntax is somewhat inconsistent. The [purrr](https://purrr.tidyverse.org/) 
library (a part of the [tidyverse](https://www.tidyverse.org/) ecosystem provides analogous operations with a cleaner syntax. 

These operations are (here `\(.x\)` is a list or atomic vector and `\(.f\)` is a function, **formula**, or vector.

+ `\(\mathrm{map}(.x, .f, ...)\)`: makes a list
+ `\(\mathrm{map\_lgl}(.x, .f, ...)\)`: makes a logical vector
+ `\(\mathrm{map\_int}(.x, .f, ...)\)`: makes an integer vector
+ `\(\mathrm{map\_dbl}(.x, .f, ...)\)`: makes a double vector
+ `\(\mathrm{map\_chr}(.x, .f, ...)\)`: makes a character vector
+ `\(\mathrm{map\_dfr}(.x, .f, ...)\)` and `\(\mathrm{map\_dfc}(.x, .f, ...)\)` makes a data-frame by row-binding or column binding.

---
class: clear

The `\(.f\)` argument to `\(\mathrm{map\_*}\)` can be either a **formula**, a string, or a number. 
For example (here we use the **dplyr** verb `\(\mathrm{group\_split}\)` to split a data frame into groups based on a factor)

.pull-left[

```r
models &lt;- mtcars %&gt;% 
  group_split(cyl) %&gt;% 
  map(function(df) 
    lm(mpg ~ wt, data = df))

models %&gt;% map(summary) %&gt;% 
  map_dbl(function(x) x$r.squared)
```

```
## [1] 0.509 0.465 0.423
```
]

.pull-right[

```r
models &lt;- mtcars %&gt;% 
  group_split(cyl) %&gt;%
  map(~ lm(mpg ~ wt, data = .))

models %&gt;% map(summary) %&gt;% 
  map_dbl(~ .$r.squared)
```

```
## [1] 0.509 0.465 0.423
```

```r
## Equivalently
models %&gt;% map(summary) %&gt;%
  map_dbl("r.squared")
```

```
## [1] 0.509 0.465 0.423
```
]
---
class: clear
To clarify the previous slide, consider

```r
str(models)
```

```
## List of 3
##  $ :List of 12
##   ..$ coefficients : Named num [1:2] 39.57 -5.65
##   .. ..- attr(*, "names")= chr [1:2] "(Intercept)" "wt"
##   ..$ residuals    : Named num [1:11] -3.6701 2.8428 1.0169 5.2523 -0.0513 ...
##   .. ..- attr(*, "names")= chr [1:11] "1" "2" "3" "4" ...
##   ..$ effects      : Named num [1:11] -88.433 10.171 0.695 6.231 1.728 ...
##   .. ..- attr(*, "names")= chr [1:11] "(Intercept)" "wt" "" "" ...
##   ..$ rank         : int 2
##   ..$ fitted.values: Named num [1:11] 26.5 21.6 21.8 27.1 30.5 ...
##   .. ..- attr(*, "names")= chr [1:11] "1" "2" "3" "4" ...
##   ..$ assign       : int [1:2] 0 1
##   ..$ qr           :List of 5
##   .. ..$ qr   : num [1:11, 1:2] -3.317 0.302 0.302 0.302 0.302 ...
##   .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. ..$ : chr [1:11] "1" "2" "3" "4" ...
##   .. .. .. ..$ : chr [1:2] "(Intercept)" "wt"
##   .. .. ..- attr(*, "assign")= int [1:2] 0 1
##   .. ..$ qraux: num [1:2] 1.3 1.5
##   .. ..$ pivot: int [1:2] 1 2
##   .. ..$ tol  : num 1e-07
##   .. ..$ rank : int 2
##   .. ..- attr(*, "class")= chr "qr"
##   ..$ df.residual  : int 9
##   ..$ xlevels      : Named list()
##   ..$ call         : language lm(formula = mpg ~ wt, data = .)
##   ..$ terms        :Classes 'terms', 'formula'  language mpg ~ wt
##   .. .. ..- attr(*, "variables")= language list(mpg, wt)
##   .. .. ..- attr(*, "factors")= int [1:2, 1] 0 1
##   .. .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. .. ..$ : chr [1:2] "mpg" "wt"
##   .. .. .. .. ..$ : chr "wt"
##   .. .. ..- attr(*, "term.labels")= chr "wt"
##   .. .. ..- attr(*, "order")= int 1
##   .. .. ..- attr(*, "intercept")= int 1
##   .. .. ..- attr(*, "response")= int 1
##   .. .. ..- attr(*, ".Environment")=&lt;environment: 0x55645eace988&gt; 
##   .. .. ..- attr(*, "predvars")= language list(mpg, wt)
##   .. .. ..- attr(*, "dataClasses")= Named chr [1:2] "numeric" "numeric"
##   .. .. .. ..- attr(*, "names")= chr [1:2] "mpg" "wt"
##   ..$ model        :'data.frame':	11 obs. of  2 variables:
##   .. ..$ mpg: num [1:11] 22.8 24.4 22.8 32.4 30.4 33.9 21.5 27.3 26 30.4 ...
##   .. ..$ wt : num [1:11] 2.32 3.19 3.15 2.2 1.61 ...
##   .. ..- attr(*, "terms")=Classes 'terms', 'formula'  language mpg ~ wt
##   .. .. .. ..- attr(*, "variables")= language list(mpg, wt)
##   .. .. .. ..- attr(*, "factors")= int [1:2, 1] 0 1
##   .. .. .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. .. .. ..$ : chr [1:2] "mpg" "wt"
##   .. .. .. .. .. ..$ : chr "wt"
##   .. .. .. ..- attr(*, "term.labels")= chr "wt"
##   .. .. .. ..- attr(*, "order")= int 1
##   .. .. .. ..- attr(*, "intercept")= int 1
##   .. .. .. ..- attr(*, "response")= int 1
##   .. .. .. ..- attr(*, ".Environment")=&lt;environment: 0x55645eace988&gt; 
##   .. .. .. ..- attr(*, "predvars")= language list(mpg, wt)
##   .. .. .. ..- attr(*, "dataClasses")= Named chr [1:2] "numeric" "numeric"
##   .. .. .. .. ..- attr(*, "names")= chr [1:2] "mpg" "wt"
##   ..- attr(*, "class")= chr "lm"
##  $ :List of 12
##   ..$ coefficients : Named num [1:2] 28.41 -2.78
##   .. ..- attr(*, "names")= chr [1:2] "(Intercept)" "wt"
##   ..$ residuals    : Named num [1:7] -0.125 0.584 1.929 -0.69 0.355 ...
##   .. ..- attr(*, "names")= chr [1:7] "1" "2" "3" "4" ...
##   ..$ effects      : Named num [1:7] -52.235 -2.427 2.111 -0.353 0.679 ...
##   .. ..- attr(*, "names")= chr [1:7] "(Intercept)" "wt" "" "" ...
##   ..$ rank         : int 2
##   ..$ fitted.values: Named num [1:7] 21.1 20.4 19.5 18.8 18.8 ...
##   .. ..- attr(*, "names")= chr [1:7] "1" "2" "3" "4" ...
##   ..$ assign       : int [1:2] 0 1
##   ..$ qr           :List of 5
##   .. ..$ qr   : num [1:7, 1:2] -2.646 0.378 0.378 0.378 0.378 ...
##   .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. ..$ : chr [1:7] "1" "2" "3" "4" ...
##   .. .. .. ..$ : chr [1:2] "(Intercept)" "wt"
##   .. .. ..- attr(*, "assign")= int [1:2] 0 1
##   .. ..$ qraux: num [1:2] 1.38 1.12
##   .. ..$ pivot: int [1:2] 1 2
##   .. ..$ tol  : num 1e-07
##   .. ..$ rank : int 2
##   .. ..- attr(*, "class")= chr "qr"
##   ..$ df.residual  : int 5
##   ..$ xlevels      : Named list()
##   ..$ call         : language lm(formula = mpg ~ wt, data = .)
##   ..$ terms        :Classes 'terms', 'formula'  language mpg ~ wt
##   .. .. ..- attr(*, "variables")= language list(mpg, wt)
##   .. .. ..- attr(*, "factors")= int [1:2, 1] 0 1
##   .. .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. .. ..$ : chr [1:2] "mpg" "wt"
##   .. .. .. .. ..$ : chr "wt"
##   .. .. ..- attr(*, "term.labels")= chr "wt"
##   .. .. ..- attr(*, "order")= int 1
##   .. .. ..- attr(*, "intercept")= int 1
##   .. .. ..- attr(*, "response")= int 1
##   .. .. ..- attr(*, ".Environment")=&lt;environment: 0x55645eb04570&gt; 
##   .. .. ..- attr(*, "predvars")= language list(mpg, wt)
##   .. .. ..- attr(*, "dataClasses")= Named chr [1:2] "numeric" "numeric"
##   .. .. .. ..- attr(*, "names")= chr [1:2] "mpg" "wt"
##   ..$ model        :'data.frame':	7 obs. of  2 variables:
##   .. ..$ mpg: num [1:7] 21 21 21.4 18.1 19.2 17.8 19.7
##   .. ..$ wt : num [1:7] 2.62 2.88 3.21 3.46 3.44 ...
##   .. ..- attr(*, "terms")=Classes 'terms', 'formula'  language mpg ~ wt
##   .. .. .. ..- attr(*, "variables")= language list(mpg, wt)
##   .. .. .. ..- attr(*, "factors")= int [1:2, 1] 0 1
##   .. .. .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. .. .. ..$ : chr [1:2] "mpg" "wt"
##   .. .. .. .. .. ..$ : chr "wt"
##   .. .. .. ..- attr(*, "term.labels")= chr "wt"
##   .. .. .. ..- attr(*, "order")= int 1
##   .. .. .. ..- attr(*, "intercept")= int 1
##   .. .. .. ..- attr(*, "response")= int 1
##   .. .. .. ..- attr(*, ".Environment")=&lt;environment: 0x55645eb04570&gt; 
##   .. .. .. ..- attr(*, "predvars")= language list(mpg, wt)
##   .. .. .. ..- attr(*, "dataClasses")= Named chr [1:2] "numeric" "numeric"
##   .. .. .. .. ..- attr(*, "names")= chr [1:2] "mpg" "wt"
##   ..- attr(*, "class")= chr "lm"
##  $ :List of 12
##   ..$ coefficients : Named num [1:2] 23.87 -2.19
##   .. ..- attr(*, "names")= chr [1:2] "(Intercept)" "wt"
##   ..$ residuals    : Named num [1:14] 2.374 -1.741 1.455 1.61 -0.381 ...
##   .. ..- attr(*, "names")= chr [1:14] "1" "2" "3" "4" ...
##   ..$ effects      : Named num [1:14] -56.499 -6.003 0.816 1.22 -0.807 ...
##   .. ..- attr(*, "names")= chr [1:14] "(Intercept)" "wt" "" "" ...
##   ..$ rank         : int 2
##   ..$ fitted.values: Named num [1:14] 16.3 16 14.9 15.7 15.6 ...
##   .. ..- attr(*, "names")= chr [1:14] "1" "2" "3" "4" ...
##   ..$ assign       : int [1:2] 0 1
##   ..$ qr           :List of 5
##   .. ..$ qr   : num [1:14, 1:2] -3.742 0.267 0.267 0.267 0.267 ...
##   .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. ..$ : chr [1:14] "1" "2" "3" "4" ...
##   .. .. .. ..$ : chr [1:2] "(Intercept)" "wt"
##   .. .. ..- attr(*, "assign")= int [1:2] 0 1
##   .. ..$ qraux: num [1:2] 1.27 1.11
##   .. ..$ pivot: int [1:2] 1 2
##   .. ..$ tol  : num 1e-07
##   .. ..$ rank : int 2
##   .. ..- attr(*, "class")= chr "qr"
##   ..$ df.residual  : int 12
##   ..$ xlevels      : Named list()
##   ..$ call         : language lm(formula = mpg ~ wt, data = .)
##   ..$ terms        :Classes 'terms', 'formula'  language mpg ~ wt
##   .. .. ..- attr(*, "variables")= language list(mpg, wt)
##   .. .. ..- attr(*, "factors")= int [1:2, 1] 0 1
##   .. .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. .. ..$ : chr [1:2] "mpg" "wt"
##   .. .. .. .. ..$ : chr "wt"
##   .. .. ..- attr(*, "term.labels")= chr "wt"
##   .. .. ..- attr(*, "order")= int 1
##   .. .. ..- attr(*, "intercept")= int 1
##   .. .. ..- attr(*, "response")= int 1
##   .. .. ..- attr(*, ".Environment")=&lt;environment: 0x55645ec25a80&gt; 
##   .. .. ..- attr(*, "predvars")= language list(mpg, wt)
##   .. .. ..- attr(*, "dataClasses")= Named chr [1:2] "numeric" "numeric"
##   .. .. .. ..- attr(*, "names")= chr [1:2] "mpg" "wt"
##   ..$ model        :'data.frame':	14 obs. of  2 variables:
##   .. ..$ mpg: num [1:14] 18.7 14.3 16.4 17.3 15.2 10.4 10.4 14.7 15.5 15.2 ...
##   .. ..$ wt : num [1:14] 3.44 3.57 4.07 3.73 3.78 ...
##   .. ..- attr(*, "terms")=Classes 'terms', 'formula'  language mpg ~ wt
##   .. .. .. ..- attr(*, "variables")= language list(mpg, wt)
##   .. .. .. ..- attr(*, "factors")= int [1:2, 1] 0 1
##   .. .. .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. .. .. ..$ : chr [1:2] "mpg" "wt"
##   .. .. .. .. .. ..$ : chr "wt"
##   .. .. .. ..- attr(*, "term.labels")= chr "wt"
##   .. .. .. ..- attr(*, "order")= int 1
##   .. .. .. ..- attr(*, "intercept")= int 1
##   .. .. .. ..- attr(*, "response")= int 1
##   .. .. .. ..- attr(*, ".Environment")=&lt;environment: 0x55645ec25a80&gt; 
##   .. .. .. ..- attr(*, "predvars")= language list(mpg, wt)
##   .. .. .. ..- attr(*, "dataClasses")= Named chr [1:2] "numeric" "numeric"
##   .. .. .. .. ..- attr(*, "names")= chr [1:2] "mpg" "wt"
##   ..- attr(*, "class")= chr "lm"
```

```r
names(models[[1]])
```

```
##  [1] "coefficients"  "residuals"     "effects"       "rank"         
##  [5] "fitted.values" "assign"        "qr"            "df.residual"  
##  [9] "xlevels"       "call"          "terms"         "model"
```
---
class: clear

```r
str(summary(models[[1]]))
```

```
## List of 11
##  $ call         : language lm(formula = mpg ~ wt, data = .)
##  $ terms        :Classes 'terms', 'formula'  language mpg ~ wt
##   .. ..- attr(*, "variables")= language list(mpg, wt)
##   .. ..- attr(*, "factors")= int [1:2, 1] 0 1
##   .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. ..$ : chr [1:2] "mpg" "wt"
##   .. .. .. ..$ : chr "wt"
##   .. ..- attr(*, "term.labels")= chr "wt"
##   .. ..- attr(*, "order")= int 1
##   .. ..- attr(*, "intercept")= int 1
##   .. ..- attr(*, "response")= int 1
##   .. ..- attr(*, ".Environment")=&lt;environment: 0x55645eace988&gt; 
##   .. ..- attr(*, "predvars")= language list(mpg, wt)
##   .. ..- attr(*, "dataClasses")= Named chr [1:2] "numeric" "numeric"
##   .. .. ..- attr(*, "names")= chr [1:2] "mpg" "wt"
##  $ residuals    : Named num [1:11] -3.6701 2.8428 1.0169 5.2523 -0.0513 ...
##   ..- attr(*, "names")= chr [1:11] "1" "2" "3" "4" ...
##  $ coefficients : num [1:2, 1:4] 39.57 -5.65 4.35 1.85 9.1 ...
##   ..- attr(*, "dimnames")=List of 2
##   .. ..$ : chr [1:2] "(Intercept)" "wt"
##   .. ..$ : chr [1:4] "Estimate" "Std. Error" "t value" "Pr(&gt;|t|)"
##  $ aliased      : Named logi [1:2] FALSE FALSE
##   ..- attr(*, "names")= chr [1:2] "(Intercept)" "wt"
##  $ sigma        : num 3.33
##  $ df           : int [1:3] 2 9 2
##  $ r.squared    : num 0.509
##  $ adj.r.squared: num 0.454
##  $ fstatistic   : Named num [1:3] 9.32 1 9
##   ..- attr(*, "names")= chr [1:3] "value" "numdf" "dendf"
##  $ cov.unscaled : num [1:2, 1:2] 1.701 -0.705 -0.705 0.308
##   ..- attr(*, "dimnames")=List of 2
##   .. ..$ : chr [1:2] "(Intercept)" "wt"
##   .. ..$ : chr [1:2] "(Intercept)" "wt"
##  - attr(*, "class")= chr "summary.lm"
```

```r
names(summary(models[[1]]))
```

```
##  [1] "call"          "terms"         "residuals"     "coefficients" 
##  [5] "aliased"       "sigma"         "df"            "r.squared"    
##  [9] "adj.r.squared" "fstatistic"    "cov.unscaled"
```
---
class: clear

```r
x &lt;- list(list(1,2,3), list(4,5,6), list(7,8,9))
## Extract 2nd element from each list
x %&gt;% sapply('[[',2) 
```

```
## [1] 2 5 8
```

```r
x %&gt;% sapply('[' ,2) ## this does not work
```

```
## [[1]]
## [1] 2
## 
## [[2]]
## [1] 5
## 
## [[3]]
## [1] 8
```

```r
x %&gt;% map_dbl(2)
```

```
## [1] 2 5 8
```
---
class: clear
The analogue of `mapply` for mapping over multiple arguments is `map2` and `pmap`.
.pull-left[

```r
mean = c(0,1,2)
sd = c(1,2,3)
mapply(rnorm, mean, sd, 3) ## Oops
```

```
## [[1]]
## numeric(0)
## 
## [[2]]
## [1] 3.34
## 
## [[3]]
## [1] 0.309 3.869
```

```r
mapply(rnorm, mean = mean, 
       sd = sd, n = 3)
```

```
##        [,1] [,2]  [,3]
## [1,] -1.182 3.64 0.187
## [2,]  0.113 4.26 7.872
## [3,] -0.600 4.00 5.792
```
]

.pull-right[

```r
pmap_dfc(list(mean = mean,sd = sd), 
         rnorm, 3)
```

```
## # A tibble: 3 × 3
##     ...1     ...2  ...3
##    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
## 1  0.584 -1.70     1.03
## 2  0.873  0.00460  5.35
## 3 -0.951  0.759    6.95
```
]

---
class: clear
For even more complex iterations, there is `invoke_map`, e.g.,
.pull-left[

```r
f &lt;- c("runif", "rnorm", "rbinom")
param &lt;- list(
  list(min = -1, max = 1),
  list(sd = 5),
  list(size = 10, prob = 0.5)
)
invoke_map(f, param, n = 1)

n &lt;- list(list(n = 2),
          list(n = 3),
          list(n = 4))

invoke_map(f, 
  map2(.x = param, .y = n, c))
```
]

.pull-right[

```
## [[1]]
## [1] -0.932
## 
## [[2]]
## [1] -5.04
## 
## [[3]]
## [1] 1
```

```
## [[1]]
## [1] -0.313  0.214
## 
## [[2]]
## [1] -5.20  9.68 -6.29
## 
## [[3]]
## [1] 5 4 2 5
```
]

---
#Example 4: Baseball winning %
In this example we try to model the winning percentage of baseball teams in terms of simpler statistics such as the number of runs scored and runs allowed.
We follow the presentation from section 4.2 and 7.5 of [MDSR](https://mdsr-book.github.io/mdsre).

A popular model in [sabermetrics](https://en.wikipedia.org/wiki/Sabermetrics)
is that a rough estimate of a team's expected winning percentage is (here `\(RS\)` and `\(RA\)` denote the total number of runs scored and runs allowed in a season). 
`$$\widehat{Wpct} = \frac{1}{1 + (RA/RS)^{k}}$$`
for some choice of `\(k\)`; [Bill James](https://en.wikipedia.org/wiki/Bill_James) posited that `\(k = 2\)`. 

We now verify this expression using data from the [Lahman](https://cran.r-project.org/web/packages/Lahman/index.html) library.
---
class: clear

```r
exp_wpct &lt;- function(x, k = 2) { 
  return(1/(1 + (1/x)^k))
}
library(Lahman)
TeamRuns &lt;- Teams %&gt;% 
  rename(RS = R) %&gt;% 
  mutate(wpct = W / (W + L), run_ratio = RS/RA, 
         hat.wpct = exp_wpct(run_ratio)) %&gt;%
  select(yearID, teamID, lgID, wpct, hat.wpct, run_ratio) 
TeamRuns
```

```
## # A tibble: 3,015 × 6
##   yearID teamID lgID   wpct hat.wpct run_ratio
##    &lt;int&gt; &lt;fct&gt;  &lt;fct&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1   1871 BS1    NA    0.667    0.637     1.32 
## 2   1871 CH1    NA    0.679    0.611     1.25 
## 3   1871 CL1    NA    0.345    0.348     0.730
## # ℹ 3,012 more rows
```
---
class: clear
The following figure provides reasonably strong support to Bill Jame's formula.

```r
ggplot(data = TeamRuns, aes(x = run_ratio, y = wpct)) +
  geom_vline(xintercept = 1, color = "darkgray", linetype = 2) +
  geom_hline(yintercept = 0.5, color = "darkgray", linetype = 2) +
  geom_point(alpha = 0.3) + 
  stat_function(fun = exp_wpct, size = 2, color = "blue") + 
  xlab("Ratio of Runs Scored to Runs Allowed") + ylab("Winning Percentage")
```

&lt;img src="intro_tidy_files/figure-html/unnamed-chunk-95-1.png" width="80%" style="display: block; margin: auto;" /&gt;
---
class: clear
Nevertheless, we might ask whether or not `\(k = 2\)` really the "optimal" choice for this data ? 

To answer this, we find `\(\hat{k}\)` minimizing the (non-linear) least square criterion
`$$\min_{k} \sum_{i} \Bigl(\mathrm{Wpct}_{i} - \frac{1}{1 + (\mathrm{RA}_i/\mathrm{RS}_i)^{k}} \Bigr)^2.$$`

Efficient algorithms for finding `\(\hat{k}\)` are reasonably complicated but for our current purpose, the following grid search is sufficient. 


```r
kseq &lt;- seq(from = 0.5, to = 2.5, by = 0.01)
names(kseq) &lt;- kseq
mse &lt;- map_dbl(kseq, 
        .f = function(x,y,k) mean((y - exp_wpct(x,k))^2),
        x = TeamRuns$run_ratio, y = TeamRuns$wpct)
glimpse(mse)
```

```
##  Named num [1:201] 0.005 0.00493 0.00487 0.00481 0.00474 ...
##  - attr(*, "names")= chr [1:201] "0.5" "0.51" "0.52" "0.53" ...
```

```r
which.min(mse)
```

```
## 1.86 
##  137
```

We see that the optimal `\(k\)` for this data is roughly `\(1.87\)`.
---
class: clear
We might want to see how the "optimal" value of `\(k\)` changes over time. We see that the optimal `\(k\)` over time ranges from `\(1.74\)` to `\(2.02\)`. 

```r
fit.k &lt;- function(df, 
                  kseq = seq(from = 0.5, to = 2.5, by = 0.01), 
                  name1, name2){
  mse &lt;- map_dbl(.x = kseq, 
          .f = function(x,y,k) mean((y - exp_wpct(x,k))^2),
          x = df[[name1]], y = df[[name2]])
  idx &lt;- which.min(mse)
  return(tibble(k = kseq[idx]))
}
kseq &lt;- seq(from = 0.5, to = 2.5, by = 0.01)
kstar &lt;- TeamRuns %&gt;% mutate(decade = yearID %/%10 * 10) %&gt;%
  group_split(decade) %&gt;% map_df(fit.k, name1 = "run_ratio", name2 = "wpct")
kstar
```

```
## # A tibble: 16 × 1
##       k
##   &lt;dbl&gt;
## 1  1.95
## 2  1.82
## 3  2.02
## # ℹ 13 more rows
```
---
class: clear
Continuing in the same vein, let us identify, for each season, the team that led their league in home runs. 

+ We first write a helper function that, given records for a subset of teams,  return a data frame listing the team with the most home runs. 
+ We then split our data in groups based on `\(\mathrm{yearID}\)` and `\(\mathrm{lgID}\)` and apply our helper function to each group.

```r
hr_leader &lt;- function(x){
  x %&gt;% select(yearID, lgID, teamID, HR) %&gt;%
    arrange(desc(HR)) %&gt;% head(n = 1)
}
library(Lahman)
hr_leaders &lt;- Teams %&gt;% group_split(yearID, lgID) %&gt;%
  map_df(hr_leader)
hr_leaders
```

```
## # A tibble: 288 × 4
##   yearID lgID  teamID    HR
##    &lt;int&gt; &lt;fct&gt; &lt;fct&gt;  &lt;int&gt;
## 1   1871 NA    CH1       10
## 2   1872 NA    BL1       14
## 3   1873 NA    BS1       13
## # ℹ 285 more rows
```
---
class: clear
We then visualize how the number of home runs of the top hitting teams change over time.

```r
hr_leaders %&gt;% 
  filter(yearID &gt;= 1916) %&gt;%
  ggplot(aes(x = yearID, y = HR, color = lgID)) + geom_line() + 
    geom_point() + geom_smooth(se = 0) + geom_vline(xintercept = 1973) + 
    annotate("text", x = 1974, y = 25, 
             label = "AL adopts designated hitter rule", hjust = "left")
```

&lt;img src="intro_tidy_files/figure-html/unnamed-chunk-99-1.png" width="80%" style="display: block; margin: auto;" /&gt;
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "solarized-light",
"highlightLines": false,
"highlightSpans": false,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
